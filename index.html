<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ³¨éŸ³ç‹åœ‹æ¢éšªè¨˜ (V4 é»åœŸç‰ˆ)</title>
    
    <!-- 1. å¼•å…¥ Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 2. å¼•å…¥ Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- 3. å¼•å…¥åœ“é«”å­—å‹ (Zen Maru Gothic) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* é¦¬å¡é¾è‰²ç³» */
            --bg-color: #F0F4F8;
            --primary: #FF9EAA;    /* ç³–æœç²‰ */
            --primary-dark: #FF758F;
            --secondary: #80DEEA;  /* å¤©ç©ºè— */
            --secondary-dark: #4DD0E1;
            --accent: #FFE082;     /* å¥¶æ²¹é»ƒ */
            --text-main: #5D4037;  /* å·§å…‹åŠ›è‰² */
            
            /* é»åœŸé¢¨æ ¼é™°å½±åƒæ•¸ */
            --clay-shadow: 
                8px 8px 16px rgba(163, 177, 198, 0.4), 
                -8px -8px 16px rgba(255, 255, 255, 0.8), 
                inset 2px 2px 4px rgba(255, 255, 255, 0.5),
                inset -2px -2px 4px rgba(163, 177, 198, 0.2);
            
            --clay-shadow-pressed: 
                inset 6px 6px 10px rgba(163, 177, 198, 0.4), 
                inset -6px -6px 10px rgba(255, 255, 255, 0.8);
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif; /* å¥—ç”¨åœ“é«” */
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        /* === é»åœŸé¢¨æ ¼å…ƒä»¶ === */
        .clay-card {
            background: #F0F4F8;
            border-radius: 30px;
            border: none;
            box-shadow: var(--clay-shadow);
            padding: 20px;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .clay-card:hover {
            transform: translateY(-5px);
        }

        .clay-btn {
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            font-weight: 900;
            font-size: 1.1rem;
            color: white;
            transition: all 0.2s;
            position: relative;
            z-index: 1;
        }
        
        /* ç²‰ç´…æŒ‰éˆ• */
        .clay-btn-primary {
            background-color: var(--primary);
            box-shadow: 
                6px 6px 12px rgba(255, 117, 143, 0.4),
                -6px -6px 12px rgba(255, 255, 255, 0.5),
                inset 3px 3px 6px rgba(255, 255, 255, 0.4),
                inset -3px -3px 6px rgba(189, 52, 85, 0.1);
        }
        .clay-btn-primary:active {
            box-shadow: inset 4px 4px 8px rgba(189, 52, 85, 0.2);
            transform: scale(0.98);
        }

        /* è—è‰²æŒ‰éˆ• */
        .clay-btn-secondary {
            background-color: var(--secondary);
            box-shadow: 
                6px 6px 12px rgba(77, 208, 225, 0.4),
                -6px -6px 12px rgba(255, 255, 255, 0.5),
                inset 3px 3px 6px rgba(255, 255, 255, 0.4),
                inset -3px -3px 6px rgba(0, 137, 123, 0.1);
        }

        /* æ¨™é¡Œå€å¡Š */
        .hero-header {
            background: #F0F4F8;
            border-radius: 0 0 50px 50px;
            padding: 40px 20px;
            text-align: center;
            box-shadow: var(--clay-shadow);
            margin-bottom: 40px;
            position: relative;
            z-index: 10;
        }

        .hero-title {
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--primary-dark);
            margin-top: 15px;
            letter-spacing: 2px;
        }

        .badge-pill {
            background: #F0F4F8;
            box-shadow: var(--clay-shadow-pressed); /* å‡¹é™·æ•ˆæœ */
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: bold;
            color: var(--text-main);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        /* èª²ç¨‹åˆ—è¡¨ */
        .week-title {
            display: inline-block;
            background: var(--accent);
            color: #795548;
            padding: 8px 25px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            box-shadow: 4px 4px 8px rgba(0,0,0,0.1);
        }

        /* åœ–ç‰‡å®¹å™¨ */
        .img-container {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            transition: transform 0.3s;
        }
        .lesson-card:hover .img-container {
            transform: scale(1.1) rotate(10deg);
        }
        .custom-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1)); /* è®“åœ–ç‰‡æœ‰æµ®èµ·æ„Ÿ */
        }

        /* èª²ç¨‹è©³ç´°é  */
        .lesson-view {
            display: none;
            min-height: 100vh;
            padding-top: 20px;
        }
        .lesson-view.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        /* é€²åº¦é» */
        .dots-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        .dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #CFD8DC;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.1);
            transition: 0.3s;
        }
        .dot.active {
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
            transform: scale(1.3);
        }

        /* é–ƒç¤ºå¡ */
        .flashcard {
            background: #F0F4F8;
            border-radius: 40px;
            box-shadow: var(--clay-shadow);
            padding: 30px;
            text-align: center;
            max-width: 320px;
            margin: 0 auto;
            cursor: pointer;
            border: 4px solid white;
        }
        .flashcard:active {
            box-shadow: var(--clay-shadow-pressed);
            transform: scale(0.98);
        }
        .flashcard-zhuyin {
            font-size: 5rem;
            color: var(--primary-dark);
            font-weight: 900;
        }
        .flashcard-main-img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin: 15px auto;
            display: block;
        }

        /* æ¸¬é©—é¸é … */
        .quiz-option {
            background: #F0F4F8;
            border-radius: 20px;
            box-shadow: var(--clay-shadow);
            padding: 20px;
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            border: 3px solid transparent;
        }
        .quiz-option:active {
            box-shadow: var(--clay-shadow-pressed);
        }
        .quiz-option.correct {
            border-color: #81C784;
            background: #E8F5E9;
            color: #2E7D32;
        }
        .quiz-option.wrong {
            border-color: #EF5350;
            background: #FFEBEE;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .home-fab {
            position: fixed;
            top: 20px; left: 20px;
            width: 50px; height: 50px;
            border-radius: 50%;
            background: #F0F4F8;
            box-shadow: var(--clay-shadow);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            color: var(--text-main);
            z-index: 100;
            cursor: pointer;
        }

        /* ä½”ä½åœ–ç‰‡æç¤ºæ–‡å­— */
        .placeholder-text {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            color: #999;
            text-align: center;
            width: 100%;
            pointer-events: none;
        }
    </style>
</head>
<body>

<!-- æ…¶ç¥ç‰¹æ•ˆç•«å¸ƒ -->
<canvas id="confetti" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999;"></canvas>

<!-- é é¢ 1: é¦–é åœ°åœ– -->
<div id="page-home" class="container-fluid p-0">
    <div class="hero-header">
        <div style="width:100px; height:100px; margin:0 auto; position:relative;">
            <!-- [åœ–ç¤ºæ›¿æ›] é¦–é åŸå ¡åœ–ç‰‡ -->
            <img id="img-castle" src="assets/images/Castle.png" class="custom-img" alt="Castle">
            <span class="placeholder-text"></span>
        </div>
        <div class="hero-title">æ³¨éŸ³ç‹åœ‹æ¢éšª</div>
        
        <div class="d-flex justify-content-center gap-3 mt-4">
            <div class="badge-pill">
                <!-- [åœ–ç¤ºæ›¿æ›] å¯¶çŸ³åœ–ç¤º -->
                <img id="img-gem" src="assets/images/Gem.png" style="width:24px;" alt="Gem">
                <span id="gem-count">0</span> / 12
            </div>
            <button class="clay-btn clay-btn-secondary py-2 px-4 fs-6" onclick="resetApp()">
                <i class="fa-solid fa-rotate-right me-1"></i> é‡ç½®
            </button>
        </div>
    </div>

    <div class="container" id="course-list-container">
        <!-- èª²ç¨‹åˆ—è¡¨ç”± JS ç”Ÿæˆ -->
    </div>
</div>

<!-- é é¢ 2: èª²ç¨‹å…§å®¹ -->
<div id="page-lesson" class="lesson-view">
    <div class="home-fab" onclick="goHome()">
        <i class="fa-solid fa-house"></i>
    </div>

    <div class="container" style="max-width: 600px;">
        <div class="text-center pt-5">
            <h2 id="lesson-title" class="fw-bold" style="color: var(--text-main);">L1 æ¨™é¡Œ</h2>
            
            <div class="dots-container">
                <div class="dot active" id="dot-0"></div>
                <div class="dot" id="dot-1"></div>
                <div class="dot" id="dot-2"></div>
                <div class="dot" id="dot-3"></div>
            </div>
        </div>

        <div id="lesson-stage" class="mt-4 fade-in">
            <!-- å…§å®¹å‹•æ…‹å¡«å…… -->
        </div>
    </div>
    
    <div class="fixed-bottom p-3 text-center" style="background: rgba(240, 244, 248, 0.9); backdrop-filter: blur(5px);">
        <div class="container d-flex justify-content-between" style="max-width: 600px;">
            <button class="clay-btn clay-btn-secondary" id="btn-prev" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
            <button class="clay-btn clay-btn-primary" id="btn-next" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>
</div>

<script>
    // =========================================================================
    // ğŸ”§ [è¨­å®šå€] åœ–ç‰‡è³‡ç”¢æ¸…å–® (IMAGE ASSETS LIST)
    // è«‹åœ¨é€™è£¡å¡«å…¥æ‚¨ç”Ÿæˆçš„ 3D åœ–ç‰‡é€£çµã€‚
    // =========================================================================
    const IMAGE_ASSETS = {
        // --- ç³»çµ±åœ–ç¤º ---
        home_castle: "assets/images/Castle.png",  // é¦–é åŸå ¡
        gem_icon: "assets/images/Gem.png",        // å¯¶çŸ³å°åœ–
        finish_star: "assets/images/Star.png",    // å®Œæˆæ™‚çš„å¤§æ˜Ÿæ˜Ÿ

        // --- ç¬¬ä¸€é€±: å˜´å”‡èˆ‡èˆŒé ­çš„é«”æ“ ---
        // L1: ã„…ã„†ã„‡ã„ˆ
        l1_icon: "assets/images/Popcorn.png",     // çˆ†ç±³èŠ±
        l1_card_b: "assets/images/Bun.png",       // åŒ…å­
        l1_card_p: "assets/images/Grapes.png",    // è‘¡è„
        l1_card_m: "assets/images/Hat.png",       // å¸½å­
        l1_card_f: "assets/images/Plane.png",     // é£›æ©Ÿ
        // L2: ã„‰ã„Šã„‹ã„Œ
        l2_icon: "assets/images/Drum.png",        // é¼“  
        l2_card_d: "assets/images/Knife.png",     // åˆ€å­
        l2_card_t: "assets/images/Rabbit.png",    // å…”å­
        l2_card_n: "assets/images/Milk.png",      // ç‰›å¥¶
        l2_card_l: "assets/images/Happy.png",     // å¿«æ¨‚
        // L3: è²èª¿
        l3_icon: "assets/images/Hat2.png",        // å¸½å­
        l3_card_1: "assets/images/Road.png",      // ä¸€è²
        l3_card_2: "assets/images/Climb.png",     // äºŒè²
        l3_card_3: "assets/images/Check.png",     // ä¸‰è²
        l3_card_4: "assets/images/Slide.png",     // å››è²

        // --- ç¬¬äºŒé€±: èˆ‡ç‰™é½’çš„æ´¾å° ---
        // L4: ã„ã„ã„
        l4_icon: "assets/images/Dove.png",         // é´¿å­
        l4_card_g: "assets/images/Dove.png",       // é´¿å­
        l4_card_k: "assets/images/Tadpole.png",    // èŒèšª
        l4_card_h: "assets/images/Water.png",      // å–æ°´
        // L5: ã„ã„‘ã„’
        l5_icon: "assets/images/Watermelon.png",   // è¥¿ç“œ
        l5_card_j: "assets/images/Chick.png",      // å°é›
        l5_card_q: "assets/images/Balloon.png",    // æ°£çƒ
        l5_card_x: "assets/images/Watermelon.png", // è¥¿ç“œ
        // L6: ç¸½è¤‡ç¿’
        l6_icon: "assets/images/Trophy.png",       // çç›ƒ
        l6_card_1: "assets/images/Lips.png",       // å˜´å”‡éŸ³
        l6_card_2: "assets/images/Tongue.png",     //  èˆŒå°–éŸ³
        l6_card_3: "assets/images/Voice.png",      // å–‰åš¨éŸ³

        // --- ç¬¬ä¸‰é€±: æ²èˆŒèˆ‡å¹³å¹³èˆŒ ---
        // L7: ã„“ã„”ã„•ã„–
        l7_icon: "assets/images/Spider.png",      // èœ˜è››
        l7_card_zh: "assets/images/Spider.png",   // èœ˜è››
        l7_card_ch: "assets/images/Rice.png",     // åƒé£¯
        l7_card_sh: "assets/images/Lion.png",     // ç…å­
        l7_card_r: "assets/images/Calendar.png",  // æ—¥æ›†
        // L8: ã„—ã„˜ã„™
        l8_icon: "assets/images/Bath.png",        // æ´—æ¾¡
        l8_card_z: "assets/images/Bath.png",      // æ´—æ¾¡
        l8_card_c: "assets/images/Hedgehog.png",  // åˆºèŸ
        l8_card_s: "assets/images/Loofah.png",    // çµ²ç“œ
        // L9: è¾¨åˆ¥
        l9_icon: "assets/images/Ear.png",         // è€³æœµ
        l9_card_1: "assets/images/Curl.png",      // æ²èˆŒ
        l9_card_2: "assets/images/Flat.png",      // å¹³èˆŒ
        l9_card_3: "assets/images/Curl2.png",     //  æ²èˆŒ
        l9_card_4: "assets/images/Flat2.png",     //  å¹³èˆŒ

        // --- ç¬¬å››é€±: é­”æ³•å’’èªèˆ‡ç•¢æ¥­ ---
        // L10: ã„šã„›ã„œã„
        l10_icon: "assets/images/Mouth.png",      // å˜´å·´
        l10_card_a: "assets/images/Woman.png",    //  é˜¿å§¨
        l10_card_o: "assets/images/Rooster.png",  // å…¬é›
        l10_card_e: "assets/images/Goose.png",    //  ç™½éµ
        l10_card_ie: "assets/images/Yeah.png",    // è€¶
        // L11: ã„§ã„¨ã„©
        l11_icon: "assets/images/Train.png",      // ç«è»Š
        l11_card_i: "assets/images/Shirt.png",    //  è¡£æœ
        l11_card_u: "assets/images/Turtle.png",   // çƒé¾œ
        l11_card_yu: "assets/images/Fish.png",    //  é‡‘é­š
        // L12: ç•¢æ¥­
        l12_icon: "assets/images/Grad.png",       // ç•¢æ¥­å¸½
        l12_card_1: "assets/images/Wand.png",     // é­”æ³•æ£’(ã„…+ã„š)
        l12_card_2: "assets/images/Mom.png.png",  // åª½åª½(ã„‡+ã„š)
        l12_card_3: "assets/images/Diploma.png",  // è­‰æ›¸
        
        default: "assets/images/Icon.png"         // é è¨­åœ–
    };

    // åˆå§‹åŒ–ç³»çµ±åœ–ç‰‡
    document.getElementById('img-castle').src = IMAGE_ASSETS.home_castle;
    document.getElementById('img-gem').src = IMAGE_ASSETS.gem_icon;

    // =========================================================================
    // ğŸ“š èª²ç¨‹è³‡æ–™çµæ§‹ (ä½¿ç”¨ IMAGE_ASSETS çš„ key)
    // =========================================================================
    const courseData = [
        {
            week: 1, title: "å˜´å”‡èˆ‡èˆŒé ­çš„é«”æ“",
            lessons: [
                {
                    id: "L1", title: "L1: å•µå•µçˆ†ç±³èŠ±",
                    iconImg: IMAGE_ASSETS.l1_icon,
                    warmup: { action: "å‡è£æ˜¯çˆ†ç±³èŠ±æ©Ÿï¼Œè¹²ä¸‹ã€Œå•µã€è·³èµ·ä¾†ï¼", tip: "å‹•ä½œèª‡å¼µä¸€é»ï¼" },
                    cards: [
                        { text: "ã„…", word: "åŒ…å­", img: IMAGE_ASSETS.l1_card_b },
                        { text: "ã„†", word: "è‘¡è„", img: IMAGE_ASSETS.l1_card_p },
                        { text: "ã„‡", word: "å¸½å­", img: IMAGE_ASSETS.l1_card_m },
                        { text: "ã„ˆ", word: "é£›æ©Ÿ", img: IMAGE_ASSETS.l1_card_f }
                    ],
                    game: { title: "ç‰™é½’å¤¾å¤¾æ¨‚", desc: "ç”¨åŠ›é–‰ç·Šå˜´å·´ï¼Œä¸è¦è¢«å®¶é•·æ’¬é–‹ï¼" },
                    quiz: [
                        { q: "è‘¡è„çš„é–‹é ­è²éŸ³ï¼Ÿ", a: "ã„†", opts: ["ã„…", "ã„†", "ã„‡"] },
                        { q: "è‚šå­åœ“åœ“çš„åŒ…å­ï¼Ÿ", a: "ã„…", opts: ["ã„…", "ã„‡", "ã„ˆ"] },
                        { q: "é£›æ©Ÿçš„è²éŸ³ï¼Ÿ", a: "ã„ˆ", opts: ["ã„†", "ã„‡", "ã„ˆ"] }
                    ]
                },
                {
                    id: "L2", title: "L2: å°å°é¼“æ‰‹",
                    iconImg: IMAGE_ASSETS.l2_icon,
                    warmup: { action: "æ‹è‚šå­ã€Œã„‰ã„‰ã„‰ã€ï¼Œè¸¢è¶³çƒã€Œã„Šã„Šã„Šã€", tip: "é…åˆç¯€å¥æ„Ÿ" },
                    cards: [
                        { text: "ã„‰", word: "åˆ€å­", img: IMAGE_ASSETS.l2_card_d },
                        { text: "ã„Š", word: "å…”å­", img: IMAGE_ASSETS.l2_card_t },
                        { text: "ã„‹", word: "ç‰›å¥¶", img: IMAGE_ASSETS.l2_card_n },
                        { text: "ã„Œ", word: "å¿«æ¨‚", img: IMAGE_ASSETS.l2_card_l }
                    ],
                    game: { title: "è½éŸ³æ‰¾å­—", desc: "è¸©ä½å®¶é•·å¿µå‡ºçš„æ³¨éŸ³å­—å¡ï¼" },
                    quiz: [
                        { q: "é•·è€³æœµçš„æ˜¯ï¼Ÿ", a: "ã„Š", opts: ["ã„‰", "ã„Š", "ã„Œ"] },
                        { q: "å–ç‰›å¥¶ï¼Ÿ", a: "ã„‹", opts: ["ã„‹", "ã„Œ", "ã„‰"] },
                        { q: "åˆ‡èœè²éŸ³ï¼Ÿ", a: "ã„‰", opts: ["ã„‰", "ã„Š", "ã„‹"] }
                    ]
                },
                {
                    id: "L3", title: "L3: è²èª¿å¸½å­",
                    iconImg: IMAGE_ASSETS.l3_icon,
                    warmup: { action: "æ©Ÿå™¨äºº(å¹³)ã€é©šè¨(ä¸Š)ã€é»é ­(å‹¾)ã€ç”Ÿæ°£(å»)", tip: "ç”¨é ­éƒ¨å‹•ä½œè¼”åŠ©" },
                    cards: [
                        { text: "Ë‰", word: "å¹³å¹³è·¯", img: IMAGE_ASSETS.l3_card_1 },
                        { text: "ËŠ", word: "çˆ¬å±±å¡", img: IMAGE_ASSETS.l3_card_2 },
                        { text: "Ë‡", word: "æ‰“å‹¾å‹¾", img: IMAGE_ASSETS.l3_card_3 },
                        { text: "Ë‹", word: "æºœæ»‘æ¢¯", img: IMAGE_ASSETS.l3_card_4 }
                    ],
                    game: { title: "è²èª¿æŒ‡æ®å®¶", desc: "çœ‹æ‰‹å‹¢ç™¼å‡ºå°æ‡‰çš„è²èª¿ï¼" },
                    quiz: [
                        { q: "æºœæ»‘æ¢¯æ˜¯å¹¾è²ï¼Ÿ", a: "Ë‹", opts: ["Ë‰", "ËŠ", "Ë‹"] },
                        { q: "çˆ¬å±±å¡æ˜¯å¹¾è²ï¼Ÿ", a: "ËŠ", opts: ["ËŠ", "Ë‡", "Ë‹"] },
                        { q: "å¹³å¹³çš„æ˜¯å¹¾è²ï¼Ÿ", a: "Ë‰", opts: ["Ë‰", "ËŠ", "Ë‡"] }
                    ]
                }
            ]
        },
        {
            week: 2, title: "èˆ‡ç‰™é½’çš„æ´¾å°",
            lessons: [
                {
                    id: "L4", title: "L4: é´¿å­ç¬‘å˜»å˜»",
                    iconImg: IMAGE_ASSETS.l4_icon,
                    warmup: { action: "å‡è£æ¼±å£ã€Œå’•åš•å’•åš•ã€ï¼Œæ„Ÿå—å–‰åš¨éœ‡å‹•ã€‚", tip: "é€™æ˜¯èˆŒæ ¹éŸ³ï¼Œæ„Ÿè¦ºå–‰åš¨ç™¢ç™¢çš„ã€‚" },
                    cards: [
                        { text: "ã„", word: "é´¿å­", img: IMAGE_ASSETS.l4_card_g },
                        { text: "ã„", word: "èŒèšª", img: IMAGE_ASSETS.l4_card_k },
                        { text: "ã„", word: "å–æ°´", img: IMAGE_ASSETS.l4_card_h }
                    ],
                    game: { title: "å“ˆæ°£å¤§åŠ›å£«", desc: "æ‹¿è¡›ç”Ÿç´™æ”¾å˜´å‰ï¼Œå¿µã„æ™‚ç´™è¦é£„èµ·ä¾†ï¼" },
                    quiz: [
                        { q: "è®“è¡›ç”Ÿç´™é£›èµ·ä¾†çš„æ˜¯ï¼Ÿ", a: "ã„", opts: ["ã„", "ã„", "ã„"] },
                        { q: "é´¿å­å’•å’•å«ï¼Ÿ", a: "ã„", opts: ["ã„", "ã„", "ã„"] },
                        { q: "å°é’è›™å°æ™‚å€™ï¼Ÿ", a: "ã„", opts: ["ã„", "ã„", "ã„"] }
                    ]
                },
                {
                    id: "L5", title: "L5: å°é›æ°£çƒè¥¿ç“œ",
                    iconImg: IMAGE_ASSETS.l5_icon,
                    warmup: { action: "åšä¸€å€‹å¤§å¤§çš„å¾®ç¬‘ï¼Œç‰™é½’å°æº–ç™¼å‡ºã€Œå˜»ã€", tip: "å˜´å·´è¦è®Šæ‰æ‰çš„å–”ã€‚" },
                    cards: [
                        { text: "ã„", word: "å°é›", img: IMAGE_ASSETS.l5_card_j },
                        { text: "ã„‘", word: "æ°£çƒ", img: IMAGE_ASSETS.l5_card_q },
                        { text: "ã„’", word: "è¥¿ç“œ", img: IMAGE_ASSETS.l5_card_x }
                    ],
                    game: { title: "åˆ‡åˆ‡æ¨‚", desc: "å®¶é•·ç•¶å¤§è¥¿ç“œï¼Œå¿µã€Œã„’ã€å­©å­å°±å‡è£åˆ‡ä¸€ä¸‹ï¼" },
                    quiz: [
                        { q: "åƒæ°£çƒé£›èµ°äº†ï¼Ÿ", a: "ã„‘", opts: ["ã„", "ã„‘", "ã„’"] },
                        { q: "å°é›æ€éº¼å«ï¼Ÿ", a: "ã„", opts: ["ã„", "ã„‘", "ã„’"] },
                        { q: "å¤å¤©åƒä»€éº¼æ¶¼æ¶¼çš„ï¼Ÿ", a: "ã„’", opts: ["ã„", "ã„‘", "ã„’"] }
                    ]
                },
                {
                    id: "L6", title: "L6: ç¸½è¤‡ç¿’å¤§é—–é—œ",
                    iconImg: IMAGE_ASSETS.l6_icon,
                    warmup: { action: "å”±ã€Œã„…ã„†ã„‡ä¹‹æ­Œã€çš„å‰åŠæ®µï¼", tip: "ç¶²è·¯ä¸Šæœ‰è¨±å¤šç‰ˆæœ¬ï¼Œå¯ä»¥è·Ÿè‘—å”±ã€‚" },
                    cards: [
                        { text: "è¤‡ç¿’", word: "ã„…ã„†ã„‡", img: IMAGE_ASSETS.l6_card_1 },
                        { text: "è¤‡ç¿’", word: "ã„‰ã„Šã„‹ã„Œ", img: IMAGE_ASSETS.l6_card_2 },
                        { text: "è¤‡ç¿’", word: "ã„ã„ã„", img: IMAGE_ASSETS.l6_card_3 }
                    ],
                    game: { title: "å­—å¡é‡£é­š", desc: "ç”¨æ›¬è¡£å¤¾ç•¶é‡£ç«¿ï¼Œé‡£å‡ºå®¶é•·æŒ‡å®šçš„æ³¨éŸ³å¡ç‰‡ï¼" },
                    quiz: [
                        { q: "å“ªä¸€å€‹æ˜¯è‚šå­åœ“åœ“ï¼Ÿ", a: "ã„…", opts: ["ã„…", "ã„‡", "ã„ˆ"] },
                        { q: "å“ªä¸€å€‹æœ‰é•·è€³æœµï¼Ÿ", a: "ã„Š", opts: ["ã„‹", "ã„Š", "ã„Œ"] },
                        { q: "å“ªä¸€å€‹åƒèŒèšªï¼Ÿ", a: "ã„", opts: ["ã„", "ã„", "ã„"] }
                    ]
                }
            ]
        },
        {
            week: 3, title: "æ²èˆŒèˆ‡å¹³å¹³èˆŒ",
            lessons: [
                {
                    id: "L7", title: "L7: èœ˜è››åƒè–¯æ¢",
                    iconImg: IMAGE_ASSETS.l7_icon,
                    warmup: { action: "èˆŒé ­å¾€ä¸Šæ²ï¼Œå‡è£ç¢°åˆ°å¤©èŠ±æ¿ç™¼å‡ºã€Œã„–ã€", tip: "èˆŒé ­æ²èµ·ä¾†åƒè›‹æ²ã€‚" },
                    cards: [
                        { text: "ã„“", word: "èœ˜è››", img: IMAGE_ASSETS.l7_card_zh },
                        { text: "ã„”", word: "åƒé£¯", img: IMAGE_ASSETS.l7_card_ch },
                        { text: "ã„•", word: "ç…å­", img: IMAGE_ASSETS.l7_card_sh },
                        { text: "ã„–", word: "æ—¥æ›†", img: IMAGE_ASSETS.l7_card_r }
                    ],
                    game: { title: "ç…å­ä¾†äº†", desc: "å®¶é•·ç•¶(ã„•)ï¼Œå­©å­ç•¶èœ˜è››(ã„“)ã€‚è½åˆ°ã„•è¦è¶•å¿«èº²èµ·ä¾†ã€‚" },
                    quiz: [
                        { q: "å“ªä¸€å€‹æ˜¯ç…å­çš„è²éŸ³ï¼Ÿ", a: "ã„•", opts: ["ã„“", "ã„”", "ã„•"] },
                        { q: "èœ˜è››çµç¶²æ˜¯ï¼Ÿ", a: "ã„“", opts: ["ã„“", "ã„”", "ã„•"] },
                        { q: "è‚šå­é¤“è¦ï¼Ÿ", a: "ã„”", opts: ["ã„“", "ã„”", "ã„•"] }
                    ]
                },
                {
                    id: "L8", title: "L8: æ´—æ¾¡æ“¦æ“¦è‡‰",
                    iconImg: IMAGE_ASSETS.l8_icon,
                    warmup: { action: "å¤§å¤§çš„å¾®ç¬‘ï¼ŒèˆŒé ­å¹³å¹³é ‚ç‰™é½’ç™¼å‡ºã€Œå˜¶ã€", tip: "èˆŒé ­ä¸å¯ä»¥æ²èµ·ä¾†å–”ã€‚" },
                    cards: [
                        { text: "ã„—", word: "æ´—æ¾¡", img: IMAGE_ASSETS.l8_card_z },
                        { text: "ã„˜", word: "åˆºèŸ", img: IMAGE_ASSETS.l8_card_c },
                        { text: "ã„™", word: "çµ²ç“œ", img: IMAGE_ASSETS.l8_card_s }
                    ],
                    game: { title: "æœ¨é ­äººè®Šè®Š", desc: "è½åˆ°æ²èˆŒéŸ³å‹•ä¸€å‹•ï¼Œè½åˆ°å¹³èˆŒéŸ³(ã„—)è¦åƒæœ¨é ­äººä¸èƒ½å‹•ã€‚" },
                    quiz: [
                        { q: "åƒæ•¸å­— 2 çš„æ˜¯ï¼Ÿ", a: "ã„—", opts: ["ã„—", "ã„˜", "ã„™"] },
                        { q: "èº«é«”å°–å°–çš„åˆºèŸï¼Ÿ", a: "ã„˜", opts: ["ã„—", "ã„˜", "ã„™"] },
                        { q: "çµ²ç“œé•·é•·çš„åƒï¼Ÿ", a: "ã„™", opts: ["ã„—", "ã„˜", "ã„™"] }
                    ]
                },
                {
                    id: "L9", title: "L9: è²éŸ³è®Šè®Šè®Š",
                    iconImg: IMAGE_ASSETS.l9_icon,
                    warmup: { action: "èˆŒé ­é«”æ“ï¼šä¼¸é•·(ã„Œ)ã€æ²èµ·(ã„“)ã€è®Šå¹³(ã„—)", tip: "éˆæ´»èˆŒé ­çš„ç·´ç¿’ã€‚" },
                    cards: [
                        { text: "ã„“", word: "æ²èˆŒ", img: IMAGE_ASSETS.l9_card_1 },
                        { text: "ã„—", word: "å¹³èˆŒ", img: IMAGE_ASSETS.l9_card_2 },
                        { text: "ã„•", word: "æ²èˆŒ", img: IMAGE_ASSETS.l9_card_3 },
                        { text: "ã„™", word: "å¹³èˆŒ", img: IMAGE_ASSETS.l9_card_4 }
                    ],
                    game: { title: "èˆŒé ­è­¦å¯Ÿ", desc: "å°å­©æ‹¿é¡å­æª¢æŸ¥çˆ¸åª½å¿µå¾—å°ä¸å°ï¼" },
                    quiz: [
                        { q: "ã€Œç…å­ã€æ˜¯ï¼Ÿ", a: "æ²èˆŒ", opts: ["æ²èˆŒ", "å¹³èˆŒ", "é–‰å˜´"] },
                        { q: "ã€Œæ´—æ¾¡ã€æ˜¯ï¼Ÿ", a: "å¹³èˆŒ", opts: ["æ²èˆŒ", "å¹³èˆŒ", "é–‰å˜´"] },
                        { q: "éœ€è¦èˆŒé ­æ²èµ·ä¾†çš„æ˜¯ï¼Ÿ", a: "ã„•", opts: ["ã„•", "ã„™", "ã„—"] }
                    ]
                }
            ]
        },
        {
            week: 4, title: "é­”æ³•èªå’’èªèˆ‡ç•¢æ¥­",
            lessons: [
                {
                    id: "L10", title: "L10: å¼µå¤§å˜´å·´",
                    iconImg: IMAGE_ASSETS.l10_icon,
                    warmup: { action: "æ¯”è³½çœ‹èª°å˜´å·´å¼µæœ€å¤§(ã„š)ï¼Œçœ‹èª°å˜´å·´è®Šåœ“(ã„›)", tip: "èª‡å¼µçš„å˜´å‹æ¯”è³½ã€‚" },
                    cards: [
                        { text: "ã„š", word: "é˜¿å§¨", img: IMAGE_ASSETS.l10_card_a },
                        { text: "ã„›", word: "å…¬é›", img: IMAGE_ASSETS.l10_card_o },
                        { text: "ã„œ", word: "ç™½éµ", img: IMAGE_ASSETS.l10_card_e },
                        { text: "ã„", word: "è€¶", img: IMAGE_ASSETS.l10_card_ie }
                    ],
                    game: { title: "å˜´å‹çŒœçŒœçœ‹", desc: "å®¶é•·åªåšå˜´å‹ä¸å‡ºè²ï¼Œè®“å­©å­çŒœæ˜¯å“ªä¸€å€‹å­—ã€‚" },
                    quiz: [
                        { q: "å˜´å·´å¼µæœ€å¤§ï¼Ÿ", a: "ã„š", opts: ["ã„š", "ã„›", "ã„œ"] },
                        { q: "å…¬é›æ€éº¼å«ï¼Ÿ", a: "ã„›", opts: ["ã„š", "ã„›", "ã„œ"] },
                        { q: "æ‹ç…§è¦æ¯”ä»€éº¼ï¼Ÿ", a: "ã„", opts: ["ã„š", "ã„›", "ã„"] }
                    ]
                },
                {
                    id: "L11", title: "L11: å¯æ„›ä¸€çƒé­š",
                    iconImg: IMAGE_ASSETS.l11_icon,
                    warmup: { action: "å‡è£ç©¿è¡£æœ(ã„§)ã€å‡è£é–‹ç«è»Š(å—š)", tip: "ã„§å˜´å·´æ‰ï¼Œã„¨å˜´å·´å˜Ÿã€‚" },
                    cards: [
                        { text: "ã„§", word: "è¡£æœ", img: IMAGE_ASSETS.l11_card_i },
                        { text: "ã„¨", word: "çƒé¾œ", img: IMAGE_ASSETS.l11_card_u },
                        { text: "ã„©", word: "é‡‘é­š", img: IMAGE_ASSETS.l11_card_yu }
                    ],
                    game: { title: "ç«è»Šéå±±æ´", desc: "å¿µã€Œã„¨ã€ç«è»Šé–‹å‹•ï¼Œå¿µã€Œã„§ã€ç«è»Šæš«åœã€‚" },
                    quiz: [
                        { q: "å˜´å·´æœ€åœ“ï¼Ÿ", a: "ã„¨", opts: ["ã„§", "ã„¨", "ã„©"] },
                        { q: "ç‰™é½’å’¬é½Šï¼Ÿ", a: "ã„§", opts: ["ã„§", "ã„¨", "ã„©"] },
                        { q: "å˜Ÿå˜´å·´ä½†æ‰ä¸€é»ï¼Ÿ", a: "ã„©", opts: ["ã„§", "ã„¨", "ã„©"] }
                    ]
                },
                {
                    id: "L12", title: "L12: å°å°é­”æ³•å¸«",
                    iconImg: IMAGE_ASSETS.l12_icon,
                    warmup: { action: "æ­å–œä¾†åˆ°æœ€å¾Œä¸€é—œï¼æˆ‘å€‘ä¾†æ–½å±•é­”æ³•ã€‚", tip: "å»ºç«‹æˆå°±æ„Ÿã€‚" },
                    cards: [
                        { text: "æ‹¼è®€", word: "ã„…+ã„š", img: IMAGE_ASSETS.l12_card_1 },
                        { text: "æ‹¼è®€", word: "ã„‡+ã„š", img: IMAGE_ASSETS.l12_card_2 },
                        { text: "ç•¢æ¥­", word: "è­‰æ›¸", img: IMAGE_ASSETS.l12_card_3 }
                    ],
                    game: { title: "é­”æ³•æ“ŠæŒ", desc: "å­©å­å–Šã„…ï¼Œå®¶é•·å–Šã„šï¼Œä¸€èµ·æ“ŠæŒå–Šã€Œã„…ã„šï¼ã€" },
                    quiz: [
                        { q: "ã„… å’Œ ã„š ç¢°åœ¨ä¸€èµ·ï¼Ÿ", a: "çˆ¸", opts: ["çˆ¸", "åª½", "èŠ±"] },
                        { q: "ã„‡ å’Œ ã„š ç¢°åœ¨ä¸€èµ·ï¼Ÿ", a: "åª½", opts: ["çˆ¸", "åª½", "èŠ±"] },
                        { q: "å­¸å®Œæ³¨éŸ³äº†å—ï¼Ÿ", a: "æ˜¯", opts: ["æ˜¯", "å¦", "ä¸çŸ¥é“"] }
                    ]
                }
            ]
        }
    ];

    // ==========================================
    // é‚è¼¯æ§åˆ¶å€
    // ==========================================
    let state = { lesson: null, step: 0, cardIdx: 0, quizIdx: 0 };
    
    // TTS ç™¼éŸ³
    function speak(text) {
        if('speechSynthesis' in window){
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW'; u.rate = 0.8;
            window.speechSynthesis.speak(u);
        }
    }

    // åˆå§‹åŒ–é¦–é 
    function initHome() {
        const container = document.getElementById('course-list-container');
        container.innerHTML = '';
        const saved = JSON.parse(localStorage.getItem('zhuyinV4_progress')) || [];
        
        document.getElementById('gem-count').innerText = saved.length;

        courseData.forEach(week => {
            let html = `<div class="mb-4"><div class="week-title">${week.title}</div><div class="row g-3">`;
            week.lessons.forEach(l => {
                const isDone = saved.includes(l.id);
                html += `
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="clay-card lesson-card ${isDone ? 'border-success' : ''}" onclick="openLesson('${l.id}')">
                        <div class="d-flex align-items-center">
                            <div class="img-container">
                                <img src="${l.iconImg}" class="custom-img">
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="fw-bold mb-1">${l.title.split(':')[0]}</h5>
                                <small class="text-muted">${l.title.split(':')[1] || ''}</small>
                            </div>
                            <div class="fs-4">${isDone ? 'âœ…' : 'â–¶ï¸'}</div>
                        </div>
                    </div>
                </div>`;
            });
            html += `</div></div>`;
            container.innerHTML += html;
        });
    }

    // é–‹å•Ÿèª²ç¨‹
    function openLesson(id) {
        state.lesson = null;
        courseData.forEach(w => w.lessons.forEach(l => { if(l.id === id) state.lesson = l; }));
        if(!state.lesson) return;

        state.step = 0; state.cardIdx = 0; state.quizIdx = 0;
        document.getElementById('page-home').style.display = 'none';
        document.getElementById('page-lesson').classList.add('active');
        document.getElementById('lesson-title').innerText = state.lesson.title;
        renderStage();
    }

    // æ¸²æŸ“éšæ®µ
    function renderStage() {
        const stage = document.getElementById('lesson-stage');
        const dots = document.querySelectorAll('.dot');
        const btnNext = document.getElementById('btn-next');
        const btnPrev = document.getElementById('btn-prev');

        dots.forEach((d, i) => d.classList.toggle('active', i === state.step));
        btnPrev.disabled = (state.step === 0);
        btnNext.innerText = "ä¸‹ä¸€æ­¥";
        btnNext.style.display = 'block';

        if (state.step === 0) {
            // æš–èº«
            stage.innerHTML = `
                <div class="clay-card text-center p-4">
                    <img src="${state.lesson.iconImg}" style="height:120px; margin-bottom:20px;">
                    <h3 class="fw-bold mb-3" style="color:var(--primary-dark)">æš–èº«å‹•ä½œ</h3>
                    <p class="fs-4 fw-bold">${state.lesson.warmup.action}</p>
                    <div class="mt-3 text-muted bg-white rounded p-2 d-inline-block">
                        ğŸ’¡ ${state.lesson.warmup.tip}
                    </div>
                </div>
            `;
        } else if (state.step === 1) {
            // é–ƒç¤ºå¡
            const card = state.lesson.cards[state.cardIdx];
            setTimeout(() => speak(card.text + "ï¼Œ" + card.word), 500);
            
            stage.innerHTML = `
                <div class="flashcard" onclick="speak('${card.text}ï¼Œ${card.word}')">
                    <div class="flashcard-zhuyin">${card.text}</div>
                    <img src="${card.img}" class="flashcard-main-img">
                    <h2 class="fw-bold" style="color:#555;">${card.word}</h2>
                    <p class="text-muted mt-2 fs-6"><i class="fa-solid fa-volume-high"></i> é»æ“Šè½è²éŸ³</p>
                </div>
            `;

            if(state.cardIdx < state.lesson.cards.length - 1) {
                btnNext.innerText = "ä¸‹ä¸€å€‹å­—";
                btnNext.onclick = () => { state.cardIdx++; renderStage(); };
            } else {
                btnNext.onclick = nextStep;
            }
        } else if (state.step === 2) {
            // éŠæˆ²
            // æ¢å¾© nextStep ç¶å®š
            btnNext.onclick = nextStep;
            stage.innerHTML = `
                <div class="clay-card text-center p-5" style="background:#E0F2F1;">
                    <div style="font-size:4rem; margin-bottom:10px;">ğŸ®</div>
                    <h3 class="fw-bold mb-3" style="color:#00695C;">${state.lesson.game.title}</h3>
                    <p class="fs-4">${state.lesson.game.desc}</p>
                </div>
            `;
        } else if (state.step === 3) {
            // æ¸¬é©—
            const q = state.lesson.quiz[state.quizIdx];
            setTimeout(() => speak(q.q), 600);
            btnNext.style.display = 'none';

            let optsHtml = q.opts.map(opt => 
                `<div class="col-4"><div class="quiz-option" onclick="checkAns(this, '${opt}', '${q.a}')">${opt}</div></div>`
            ).join('');

            stage.innerHTML = `
                <div class="text-center">
                    <h3 class="fw-bold mb-4">${q.q}</h3>
                    <div class="row g-3 justify-content-center">${optsHtml}</div>
                </div>
            `;
        } else {
            // å®Œæˆ
            saveProgress(state.lesson.id);
            stage.innerHTML = `
                <div class="text-center py-5">
                    <img src="${IMAGE_ASSETS.finish_star}" style="width:120px;" class="animate__animated animate__bounceIn">
                    <h2 class="fw-bold text-primary mt-4">å¤ªæ£’äº†ï¼</h2>
                    <p class="fs-5 text-muted">ç²å¾—ä¸€é¡†å¯¶çŸ³ ğŸ’</p>
                </div>
            `;
            fireConfetti();
            btnNext.innerText = "å›åˆ°é¦–é ";
            btnNext.onclick = goHome;
            btnPrev.style.display = 'none';
        }
    }

    function prevStep() { if(state.step > 0) { state.step--; state.cardIdx=0; state.quizIdx=0; renderStage(); } }
    function nextStep() { state.step++; renderStage(); }

    function checkAns(el, ans, correct) {
        if(ans === correct) {
            el.classList.add('correct');
            speak("ç­”å°äº†");
            setTimeout(() => {
                if(state.quizIdx < 2) { state.quizIdx++; renderStage(); }
                else { nextStep(); }
            }, 1000);
        } else {
            el.classList.add('wrong');
            speak("å†è©¦ä¸€æ¬¡");
            setTimeout(() => el.classList.remove('wrong'), 500);
        }
    }

    function saveProgress(id) {
        let saved = JSON.parse(localStorage.getItem('zhuyinV4_progress')) || [];
        if(!saved.includes(id)) {
            saved.push(id);
            localStorage.setItem('zhuyinV4_progress', JSON.stringify(saved));
        }
    }

    function goHome() {
        document.getElementById('page-lesson').classList.remove('active');
        document.getElementById('page-home').style.display = 'block';
        window.speechSynthesis.cancel();
        initHome();
    }

    function resetApp() {
        if(confirm("é‡ç½®é€²åº¦ï¼Ÿ")) { localStorage.removeItem('zhuyinV4_progress'); initHome(); }
    }

    // ç´™èŠ±ç‰¹æ•ˆ
    function fireConfetti() {
        const c = document.getElementById('confetti'); const x = c.getContext('2d');
        c.width=window.innerWidth; c.height=window.innerHeight;
        let p=[]; for(let i=0;i<60;i++) p.push({x:Math.random()*c.width, y:-20, c:['#FFD54F','#4DD0E1','#FF758F'][Math.floor(Math.random()*3)], s:Math.random()*8+4, v:Math.random()*5+2});
        function d(){ x.clearRect(0,0,c.width,c.height); p.forEach(e=>{e.y+=e.v; x.fillStyle=e.c; x.fillRect(e.x,e.y,e.s,e.s)}); if(p.some(e=>e.y<c.height)) requestAnimationFrame(d); }
        d();
    }

    initHome();
</script>
</body>
</html>