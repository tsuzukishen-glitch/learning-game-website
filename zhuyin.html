<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ³¨éŸ³ç‹åœ‹æ¢éšªè¨˜</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts: åœ“é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #FF9EAA;
            --secondary: #80DEEA;
            --accent: #FFE082;
            --text-main: #5D4037;
            --btn-primary: #FF6F91; /* æŒ‰éˆ•ä¸»è‰² */
            --clay-shadow: 8px 8px 16px rgba(163, 177, 198, 0.4), -8px -8px 16px rgba(255, 255, 255, 0.8);
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            margin: 0;
            overflow: hidden; /* Canvas æ¥ç®¡æ²å‹• */
            background-color: #E0F7FA;
            user-select: none;
        }

        /* === éŠæˆ²ç•«å¸ƒ (Map) === */
        canvas#gameWorld {
            display: block;
            width: 100vw;
            height: 100vh;
            cursor: grab;
        }
        canvas#gameWorld:active {
            cursor: grabbing;
        }

        /* === UI ä»‹é¢å±¤ (HUD) === */
        #ui-layer {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* ä¸»æ¨™é¡Œ */
        .app-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 30px;
            border-radius: 30px;
            font-weight: 900;
            font-size: 1.4rem;
            color: var(--text-main);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            white-space: nowrap;
            z-index: 20;
            border: 3px solid #FFECB3;
        }

        .hud-top {
            pointer-events: auto;
            position: absolute;
            top: 20px; left: 20px; right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hud-badge {
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 15px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-weight: 900;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .btn-circle {
            width: 45px; height: 45px;
            border-radius: 50%;
            border: none;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 1.1rem;
            color: var(--text-main);
            transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-circle:active { transform: scale(0.9); }

        /* === èª²ç¨‹å…§é  (Modal) === */
        #lesson-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #F0F4F8;
            z-index: 100;
            display: none;
            flex-direction: column;
            pointer-events: auto;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .lesson-header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between;
        }

        .lesson-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 110px; /* é¿é–‹åº•éƒ¨å°èˆª */
        }

        /* åº•éƒ¨å°èˆª */
        .tab-bar {
            position: absolute;
            bottom: 30px; left: 50%;
            transform: translateX(-50%);
            width: 90%; max-width: 500px;
            background: white;
            border-radius: 50px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            display: flex; padding: 5px;
            z-index: 101;
        }
        .tab-item {
            flex: 1; text-align: center; padding: 12px 0;
            border-radius: 40px; color: #999;
            font-weight: bold; cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
        }
        .tab-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 158, 170, 0.4);
        }
        .tab-item i { font-size: 1.2rem; margin-bottom: 2px; }

        /* === é»åœŸé¢¨æ ¼å…ƒä»¶ === */
        .clay-card {
            background: white;
            border-radius: 25px;
            padding: 25px;
            box-shadow: var(--clay-shadow);
            text-align: center;
            width: 100%; /* å¼·åˆ¶æ»¿ç‰ˆ */
            height: 97%;
        }
        
        /* é–ƒç¤ºå¡å€å¡Šï¼š2æ¬„ */
        .flashcard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            height: 97%; /* ç¢ºä¿ Grid å®¹å™¨å¡«æ»¿çˆ¶å±¤ */
        }

        .flashcard {
            background: white;
            border-radius: 20px;
            padding: 10px;
            border: 3px solid transparent;
            box-shadow: 4px 4px 10px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: 0.2s;
            display: flex; flex-direction: row; align-items: center; /* æ”¹ç‚ºæ©«å‘ */
            height: 100%; /* ç¢ºä¿å¡ç‰‡å¡«æ»¿ Grid å–®å…ƒæ ¼ */
            justify-content: space-around; /* å…§å®¹åˆ†æ•£å°é½Š */
        }
        .flashcard:active {
            border-color: var(--primary);
            transform: scale(0.95);
        }
        /* èª¿æ•´åœ–ç‰‡å¤§å°é©æ‡‰æ©«å‘ç‰ˆé¢ */
        .flashcard img { width: 180px; height: 180px; object-fit: contain; margin: 0; }

        /* æ¸¬é©—é¸é …ï¼šæ©«å‘3æ¬„ (ä¿®å¾©è¦æ±‚3 & 5) */
        .quiz-options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* æ©«å‘3æ¬„ */
            gap: 10px;
            margin-top: 20px;
        }

        .quiz-option {
            background: white;
            padding: 10px;
            border-radius: 15px;
            font-size: 2rem; /* å­—é«”æ”¾å¤§ */
            font-weight: 900;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            aspect-ratio: 1/1; /* æ–¹å½¢æŒ‰éˆ• */
            border: 3px solid transparent;
        }
        .quiz-option.correct { background: #E8F5E9; color: #2E7D32; border-color: #66BB6A; }
        .quiz-option.wrong { background: #FFEBEE; color: #C62828; animation: shake 0.4s; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* === è¼‰å…¥ç•«é¢ === */
        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #E0F7FA;
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
            flex-direction: column;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>

<!-- è¼‰å…¥ä¸­ -->
<div id="loader">
    <div class="spinner-border text-primary mb-3" role="status"></div>
    <div class="fw-bold text-muted">æ­£åœ¨å»ºé€ æ³¨éŸ³ç‹åœ‹...</div>
</div>

<!-- 1. éŠæˆ²ä¸–ç•Œ (Canvas) -->
<canvas id="gameWorld"></canvas>

<!-- 2. UI ä»‹é¢å±¤ (HUD) -->
<div id="ui-layer">
    <!-- 8. ä¸»é ä¸Šæ–¹å¢åŠ åç¨± -->
    <div class="app-title">æ³¨éŸ³ç‹åœ‹æ¢éšªè¨˜</div>

    <div class="hud-top">
        <!-- å·¦å´å€å¡Šï¼šè¿”å› + æ˜Ÿæ˜Ÿ -->
        <div class="d-flex align-items-center gap-2">
            <a href="index.html" class="btn-circle text-decoration-none" title="å›åˆ°å¤§å»³">
                <i class="fa-solid fa-house text-primary"></i>
            </a>
            
            <!-- 11. çµ±æ˜Ÿè¨˜åˆ† -->
            <div class="hud-badge">
                <i class="fa-solid fa-star text-warning"></i>
                <span id="gem-count">0</span> / 12
            </div>
        </div>
        <button class="btn-circle pointer-events-auto" onclick="resetApp()" title="é‡ç½®">
            <i class="fa-solid fa-rotate-right"></i>
        </button>
    </div>
</div>

<!-- 3. èª²ç¨‹å…§å®¹å±¤ (HTML Modal) -->
<div id="lesson-modal">
    <div class="lesson-header">
        <button class="btn-circle border-0 shadow-none" onclick="closeLesson()">
            <i class="fa-solid fa-arrow-left"></i>
        </button>
        <h5 class="m-0 fw-bold" id="lesson-title-display">èª²ç¨‹æ¨™é¡Œ</h5>
        <div style="width: 50px;"></div>
    </div>

    <div class="lesson-content" id="lesson-container">
        <!-- å…§å®¹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <div class="tab-bar">
        <div class="tab-item active" id="tab-0" onclick="switchTab(0)"><i class="fa-solid fa-person-running d-block"></i>æš–èº«</div>
        <div class="tab-item" id="tab-1" onclick="switchTab(1)"><i class="fa-solid fa-layer-group d-block"></i>å­—å¡</div>
        <div class="tab-item" id="tab-2" onclick="switchTab(2)"><i class="fa-solid fa-gamepad d-block"></i>éŠæˆ²</div>
        <div class="tab-item" id="tab-3" onclick="switchTab(3)"><i class="fa-solid fa-clipboard-question d-block"></i>æ¸¬é©—</div>
    </div>
</div>

<script>
    // ==========================================
    // ğŸ¨ 1. è³‡æºèˆ‡è³‡æ–™è¨­å®š
    // ==========================================
    
    // 1. å…¨æ•¸æ¢å¾©åœ–ç‰‡è·¯å¾‘è¨­å®š
    const ASSETS = {
        // --- ç³»çµ±åœ–ç¤º ---
        home_castle: "assets/images/Castle.png",  // é¦–é åŸå ¡
        gem_icon: "assets/images/Gem.png",        // å¯¶çŸ³å°åœ–
        finish_star: "assets/images/Star.png",    // å®Œæˆæ™‚çš„å¤§æ˜Ÿæ˜Ÿ

        // --- é›²æœµåœ–ç‰‡ (æ–°å¢) ---
        cloud_1: "assets/images/Cloud1.png",
        cloud_2: "assets/images/Cloud2.png",
        cloud_3: "assets/images/Cloud3.png",
        
        // --- ç¬¬ä¸€é€±: å˜´å”‡èˆ‡èˆŒé ­çš„é«”æ“ ---
        // L1: ã„…ã„†ã„‡ã„ˆ
        l1_icon: "assets/images/Popcorn.png",     // çˆ†ç±³èŠ±
        l1_card_b: "assets/images/Bun.png",       // åŒ…å­
        l1_card_p: "assets/images/Grapes.png",    // è‘¡è„
        l1_card_m: "assets/images/Hat.png",       // å¸½å­
        l1_card_f: "assets/images/Plane.png",     // é£›æ©Ÿ
        // L2: ã„‰ã„Šã„‹ã„Œ
        l2_icon: "assets/images/Drum.png",        // é¼“  
        l2_card_d: "assets/images/Knife.png",     // åˆ€å­
        l2_card_t: "assets/images/Rabbit.png",    // å…”å­
        l2_card_n: "assets/images/Milk.png",      // ç‰›å¥¶
        l2_card_l: "assets/images/Happy.png",     // å¿«æ¨‚
        // L3: è²èª¿
        l3_icon: "assets/images/Hat2.png",        // å¸½å­
        l3_card_1: "assets/images/Road.png",      // ä¸€è²
        l3_card_2: "assets/images/Climb.png",     // äºŒè²
        l3_card_3: "assets/images/Check.png",     // ä¸‰è²
        l3_card_4: "assets/images/Slide.png",     // å››è²

        // --- ç¬¬äºŒé€±: èˆ‡ç‰™é½’çš„æ´¾å° ---
        // L4: ã„ã„ã„
        l4_icon: "assets/images/Dove.png",         // é´¿å­
        l4_card_g: "assets/images/Dove.png",       // é´¿å­
        l4_card_k: "assets/images/Tadpole.png",    // èŒèšª
        l4_card_h: "assets/images/Water.png",      // å–æ°´
        // L5: ã„ã„‘ã„’
        l5_icon: "assets/images/Watermelon.png",   // è¥¿ç“œ
        l5_card_j: "assets/images/Chick.png",      // å°é›
        l5_card_q: "assets/images/Balloon.png",    // æ°£çƒ
        l5_card_x: "assets/images/Watermelon.png", // è¥¿ç“œ
        // L6: ç¸½è¤‡ç¿’
        l6_icon: "assets/images/Trophy.png",       // çç›ƒ
        l6_card_1: "assets/images/Lips.png",       // å˜´å”‡éŸ³
        l6_card_2: "assets/images/Tongue.png",     //  èˆŒå°–éŸ³
        l6_card_3: "assets/images/Voice.png",      // å–‰åš¨éŸ³

        // --- ç¬¬ä¸‰é€±: æ²èˆŒèˆ‡å¹³å¹³èˆŒ ---
        // L7: ã„“ã„”ã„•ã„–
        l7_icon: "assets/images/Spider.png",      // èœ˜è››
        l7_card_zh: "assets/images/Spider.png",   // èœ˜è››
        l7_card_ch: "assets/images/Rice.png",     // åƒé£¯
        l7_card_sh: "assets/images/Lion.png",     // ç…å­
        l7_card_r: "assets/images/Calendar.png",  // æ—¥æ›†
        // L8: ã„—ã„˜ã„™
        l8_icon: "assets/images/Bath.png",        // æ´—æ¾¡
        l8_card_z: "assets/images/Bath.png",      // æ´—æ¾¡
        l8_card_c: "assets/images/Hedgehog.png",  // åˆºèŸ
        l8_card_s: "assets/images/Loofah.png",    // çµ²ç“œ
        // L9: è¾¨åˆ¥
        l9_icon: "assets/images/Ear.png",         // è€³æœµ
        l9_card_1: "assets/images/Tongue.png",    // æ²èˆŒ
        l9_card_2: "assets/images/Flat.png",      // å¹³èˆŒ
        l9_card_3: "assets/images/Tongue.png",     //  æ²èˆŒ
        l9_card_4: "assets/images/Flat.png",      //  å¹³èˆŒ

        // --- ç¬¬å››é€±: é­”æ³•å’’èªèˆ‡ç•¢æ¥­ ---
        // L10: ã„šã„›ã„œã„
        l10_icon: "assets/images/Mouth.png",      // å˜´å·´
        l10_card_a: "assets/images/Woman.png",    //  é˜¿å§¨
        l10_card_o: "assets/images/Rooster.png",  // å…¬é›
        l10_card_e: "assets/images/Goose.png",    //  ç™½éµ
        l10_card_ie: "assets/images/Yeah.png",    // è€¶
        // L11: ã„§ã„¨ã„©
        l11_icon: "assets/images/Train.png",      // ç«è»Š
        l11_card_i: "assets/images/Shirt.png",    //  è¡£æœ
        l11_card_u: "assets/images/Turtle.png",   // çƒé¾œ
        l11_card_yu: "assets/images/Fish.png",    //  é‡‘é­š
        // L12: ç•¢æ¥­
        l12_icon: "assets/images/Grad.png",       // ç•¢æ¥­å¸½
        l12_card_1: "assets/images/Wand.png",     // é­”æ³•æ£’(ã„…+ã„š)
        l12_card_2: "assets/images/Mom.png.png",  // åª½åª½(ã„‡+ã„š)
        l12_card_3: "assets/images/Diploma.png",  // è­‰æ›¸
        
        default: "assets/images/Icon.png"         // é è¨­åœ–
    };

    // é è¼‰åœ–ç‰‡ç‰©ä»¶ (Map ç¹ªåœ–ç”¨)
    const imgObj = {};
    for (let key in ASSETS) {
        let img = new Image();
        img.src = ASSETS[key];
        imgObj[key] = img;
    }

    // å®Œæ•´çš„èª²ç¨‹è³‡æ–™çµæ§‹ (ä½¿ç”¨æ–°ç‰ˆåœ–ç‰‡KEY)
    const COURSE_DATA = [
        {
            week: 1, title: "ç¬¬ä¸€é€±ï¼šå˜´å”‡èˆ‡èˆŒé ­çš„é«”æ“", color: "#FF9EAA",
            lessons: [
                { id: "L1", title: "L1 å•µå•µçˆ†ç±³èŠ± (ã„…ã„†ã„‡ã„ˆ)", imgKey: "l1_icon", content: { 
                    warmup: "å‡è£æˆ‘å€‘æ˜¯çˆ†ç±³èŠ±æ©Ÿï¼Œè¹²åœ¨åœ°ä¸Šï¼Œã€Œå•µ(ã„…)ï¼ã€è·³èµ·ä¾†ï¼æ¥è‘—åƒå¹æ³¡æ³¡ä¸€æ¨£ï¼Œã€Œæ™®(ã„†)ï¼ã€å¹ä¸€å£æ°£ã€‚", 
                    cards: [{t:"ã„…", w:"åŒ…å­", i:ASSETS.l1_card_b}, {t:"ã„†", w:"è‘¡è„", i:ASSETS.l1_card_p}, {t:"ã„‡", w:"å¸½å­", i:ASSETS.l1_card_m}, {t:"ã„ˆ", w:"é£›æ©Ÿ", i:ASSETS.l1_card_f}],
                    game: { title:"å˜´å”‡å¤¾å¤¾æ¨‚", desc:"è«‹å­©å­æŠ¿ä½å˜´å”‡å”¸ã€Œã„…ã€ã„†ã€ã„‡ã€ï¼Œå®¶é•·å‡è£è¦æ’¬é–‹å­©å­çš„å˜´å·´ï¼Œå­©å­è¦ç”¨åŠ›é–‰ç·Šï¼Œæ„Ÿå—å˜´å”‡çš„åŠ›é‡ã€‚" },
                    quiz: [
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œè‘¡è„ã€çš„è²éŸ³ï¼Ÿ", a:"ã„†", o:["ã„…","ã„†","ã„‡"]},
                        {q:"å“ªä¸€å€‹æ˜¯ã€ŒåŒ…å­ã€çš„è²éŸ³ï¼Ÿ", a:"ã„…", o:["ã„…","ã„†","ã„ˆ"]},
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œé£›æ©Ÿã€çš„è²éŸ³ï¼Ÿ", a:"ã„ˆ", o:["ã„‡","ã„ˆ","ã„…"]}
                    ]
                }},
                { id: "L2", title: "L2 å°é¼“æ‰‹å’šå’šå’š (ã„‰ã„Šã„‹ã„Œ)", imgKey: "l2_icon", content: {
                    warmup: "å¤§å®¶ç•¶å°é¼“æ‰‹ï¼Œç”¨æ‰‹æ‹å¤§è…¿ï¼Œã€Œã„‰ã€ã„‰ã€ã„‰ã€ï¼æ¥è‘—å‡è£è¸¢è¶³çƒï¼Œã€Œã„Šã€ã„Šã€ã„Šã€ï¼",
                    cards: [{t:"ã„‰", w:"åˆ€å­", i:ASSETS.l2_card_d}, {t:"ã„Š", w:"å…”å­", i:ASSETS.l2_card_t}, {t:"ã„‹", w:"ç‰›å¥¶", i:ASSETS.l2_card_n}, {t:"ã„Œ", w:"å¿«æ¨‚", i:ASSETS.l2_card_l}],
                    game: { title:"è½éŸ³è¸©è¸©æ¨‚", desc:"å®¶é•·æŠŠå››å¼µå­—å¡æ•£è½åœ¨åœ°ä¸Šã€‚å®¶é•·å”¸ã€Œã„‹ã„‹ã„‹ã€ï¼Œå­©å­è¦è·‘å»è¸©(æˆ–æ‹)ã€Œã„‹ã€çš„å­—å¡ã€‚" },
                    quiz: [
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œå…”å­ã€çš„è²éŸ³ï¼Ÿ", a:"ã„Š", o:["ã„‰","ã„Š","ã„Œ"]},
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œç‰›å¥¶ã€çš„è²éŸ³ï¼Ÿ", a:"ã„‹", o:["ã„‹","ã„Œ","ã„‰"]},
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œå¿«æ¨‚ã€çš„è²éŸ³ï¼Ÿ", a:"ã„Œ", o:["ã„‰","ã„Š","ã„Œ"]}
                    ]
                }},
                { id: "L3", title: "L3 è²èª¿åœ‹ç‹çš„å¸½å­ (å››è²ç·´ç¿’)", imgKey: "l3_icon", content: {
                    warmup: "å­¸æ©Ÿå™¨äººèªªè©±(ä¸€è²)ã€å­¸é©šè¨èªªã€Œè›¤ï¼Ÿã€(äºŒè²)ã€å­¸é»é ­èªªã€Œå¥½ã€(ä¸‰è²)ã€å­¸å«äººèªªã€Œå»ï¼ã€(å››è²)ã€‚",
                    cards: [{t:"Ë‰", w:"å¹³å¹³çš„é¦¬è·¯", i:ASSETS.l3_card_1}, {t:"ËŠ", w:"çˆ¬ä¸Šå±±å¡ ", i:ASSETS.l3_card_2}, {t:"Ë‡", w:"ä¸‹å¡å†ä¸Šå¡ï¼Œæ‰“å‹¾å‹¾", i:ASSETS.l3_card_3}, {t:"Ë‹", w:"æºœæ»‘æ¢¯æºœä¸‹ä¾†", i:ASSETS.l3_card_4}],
                    game: { title:"è²èª¿æŒ‡æ®å®¶", desc:"å®¶é•·æ¯”æ‰‹å‹¢ï¼ˆä¾‹å¦‚æ‰‹å¾€ä¸Šæšï¼‰ï¼Œå­©å­è¦ç™¼å‡ºå°æ‡‰çš„äºŒè²è²éŸ³ï¼ˆéš¨ä¾¿ä¸€å€‹éŸ³ï¼Œå¦‚ã„‡ã„šËŠï¼‰ã€‚" },
                    quiz: [
                        {q:"æºœæ»‘æ¢¯æ˜¯å¹¾è²ï¼Ÿ", a:"Ë‹", o:["Ë‰","ËŠ","Ë‹"]},
                        {q:"çˆ¬å±±å¡æ˜¯å¹¾è²ï¼Ÿ", a:"ËŠ", o:["Ë‰","ËŠ","Ë‡"]},
                        {q:"æ‰“å‹¾å‹¾æ˜¯å¹¾è²ï¼Ÿ", a:"Ë‡", o:["ËŠ","Ë‡","Ë‹"]}
                    ]
                }}
            ]
        },
        {
            week: 2, title: "ç¬¬äºŒé€±ï¼šå–‰åš¨èˆ‡ç‰™é½’çš„æ´¾å°", color: "#80DEEA",
            lessons: [
                { id: "L4", title: "L4 é´¿å­å“¥å“¥ç¬‘å‘µå‘µ (ã„ã„ã„)", imgKey: "l4_icon", content: { 
                    warmup: "å‡è£æ¼±å£ã€Œå’•åš•å’•åš•ã€ï¼Œæ„Ÿå—å–‰åš¨éœ‡å‹•ã€‚", 
                    cards: [{t:"ã„", w:"é´¿å­", i:ASSETS.l4_card_g}, {t:"ã„", w:"èŒèšª", i:ASSETS.l4_card_k}, {t:"ã„", w:"å–æ°´", i:ASSETS.l4_card_h}],
                    game: { title:"å“ˆæ°£å¤§åŠ›å£«", desc:"æ‹¿ä¸€å¼µè¡›ç”Ÿç´™æ”¾åœ¨å˜´å·´å‰ã€‚å”¸ã„æ™‚ç´™ä¸å‹•ï¼Œå”¸ã„æ™‚ç´™æœƒé£›ä¸€é»é»ï¼Œå”¸ã„æ™‚ç´™æœƒé£„èµ·ä¾†ã€‚æ¯”è³½èª°è®“è¡›ç”Ÿç´™é£„æœ€é«˜ã€‚" },
                    quiz: [
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œå–æ°´ã€çš„è²éŸ³ï¼Ÿ", a:"ã„", o:["ã„","ã„","ã„"]},
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œé´¿å­ã€çš„è²éŸ³ï¼Ÿ", a:"ã„", o:["ã„","ã„","ã„"]},
                        {q:"å“ªä¸€å€‹æ˜¯ã€ŒèŒèšªã€çš„è²éŸ³ï¼Ÿ", a:"ã„", o:["ã„","ã„","ã„"]}
                    ]
                }},
                { id: "L5", title: "L5 å°é›æ°£çƒè¥¿ç“œ (ã„ã„‘ã„’)", imgKey: "l5_icon", content: { 
                    warmup: "åšä¸€å€‹å¤§å¤§çš„å¾®ç¬‘ï¼Œç‰™é½’å°é½Šï¼Œç™¼å‡ºã€Œå˜»(ã„’)ã€çš„è²éŸ³ã€‚", 
                    cards: [{t:"ã„", w:"å°é›", i:ASSETS.l5_card_j}, {t:"ã„‘", w:"æ°£çƒ", i:ASSETS.l5_card_q}, {t:"ã„’", w:"è¥¿ç“œ", i:ASSETS.l5_card_x}],
                    game: { title:"åˆ‡åˆ‡æ¨‚", desc:"å®¶é•·ç•¶å¤§è¥¿ç“œï¼Œå­©å­ç•¶å°åˆ€å­ã€‚å®¶é•·å”¸ã€Œã„’ã€ï¼Œå­©å­å°±è·‘ä¾†å‡è£åˆ‡ä¸€ä¸‹å®¶é•·çš„æ‰‹è‡‚ã€‚å”¸ã€Œã„ã€å°±å­¸å°é›å•„ç±³ã€‚" },
                    quiz: [
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œè¥¿ç“œã€çš„è²éŸ³ï¼Ÿ", a:"ã„’", o:["ã„","ã„‘","ã„’"]},
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œæ°£çƒã€çš„è²éŸ³ï¼Ÿ", a:"ã„‘", o:["ã„","ã„‘","ã„’"]},
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œå°é›ã€çš„è²éŸ³ï¼Ÿ", a:"ã„", o:["ã„","ã„‘","ã„’"]}
                    ]
                }},
                { id: "L6", title: "L6 ç¸½è¤‡ç¿’", imgKey: "l6_icon", content: { 
                    warmup: "å”±ã€Œã„…ã„†ã„‡ä¹‹æ­Œã€çš„å‰åŠæ®µã€‚", 
                    cards: [{t:"è¤‡ç¿’", w:"ã„…ã„†ã„‡", i:ASSETS.l6_card_1}, {t:"è¤‡ç¿’", w:"ã„‰ã„Šã„‹", i:ASSETS.l6_card_2}, {t:"è¤‡ç¿’", w:"ã„ã„ã„", i:ASSETS.l6_card_3}],
                    game: { title:"å­—å¡é‡£é­š", desc:"æŠŠå­—å¡é‹ªåœ¨åœ°ä¸Šï¼Œç”¨è¡£æ¶ç¶ç¹©å­ç•¶é‡£ç«¿ã€‚å®¶é•·ä¸‹æŒ‡ä»¤ï¼šã€Œè«‹é‡£ä¸€éš»ã€é´¿å­ã€(ã„)ï¼ã€å­©å­é‡£åˆ°å¾Œè¦å¤§è²å”¸å‡ºä¾†ã€‚" },
                    quiz: [
                        {q:"å“ªä¸€å€‹æ˜¯åœ“å”‡éŸ³ï¼Ÿ", a:"ã„…", o:["ã„…","ã„","ã„’"]},
                        {q:"å“ªä¸€å€‹æ˜¯èˆŒå°–éŸ³ï¼Ÿ", a:"ã„‰", o:["ã„‰","ã„","ã„"]},
                        {q:"å“ªä¸€å€‹æ˜¯å–‰åš¨éŸ³ï¼Ÿ", a:"ã„", o:["ã„","ã„…","ã„‰"]}
                    ]
                }}
            ]
        },
        {
            week: 3, title: "ç¬¬ä¸‰é€±ï¼šæ²æ²èˆŒèˆ‡å¹³å¹³èˆŒ", color: "#FFE082",
            lessons: [
                { id: "L7", title: "L7 èœ˜è››åƒè–¯æ¢ (ã„“ã„”ã„•ã„–)", imgKey: "l7_icon", content: {
                    warmup: "èˆŒé ­é«”æ“ï¼šèˆŒé ­å¾€ä¸Šæ²ï¼Œå‡è£è¦ç¢°åˆ°å¤©èŠ±æ¿(ä¸Šé¡)ã€‚ç™¼å‡ºå¼•æ“è²ã€Œã„–ã„–ã„–ã€ã€‚",
                    cards: [{t:"ã„“", w:"èœ˜è››", i:ASSETS.l7_card_zh}, {t:"ã„”", w:"åƒé£¯", i:ASSETS.l7_card_ch}, {t:"ã„•", w:"ç…å­", i:ASSETS.l7_card_sh}, {t:"ã„–", w:"æ—¥æ›†", i:ASSETS.l7_card_r}],
                    game: { title:"ç…å­ä¾†äº†", desc:"å®¶é•·ç•¶ç…å­(ã„•)ï¼Œå­©å­ç•¶èœ˜è››(ã„“)ã€‚è½åˆ°ã„•è¦è¶•å¿«èº²èµ·ä¾†ï¼Œè½åˆ°ã„“è¦æ¯”å‡ºèœ˜è››äººæ‰‹å‹¢ã€‚" },
                    quiz: [
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œç…å­ã€çš„è²éŸ³ï¼Ÿ", a:"ã„•", o:["ã„“","ã„”","ã„•"]},
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œèœ˜è››ã€çš„è²éŸ³ï¼Ÿ", a:"ã„“", o:["ã„“","ã„”","ã„•"]},
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œåƒé£¯ã€çš„è²éŸ³ï¼Ÿ", a:"ã„”", o:["ã„“","ã„”","ã„•"]}
                    ]
                }},
                { id: "L8", title: "L8 æ´—æ¾¡æ“¦æ“¦è‡‰ (ã„—ã„˜ã„™)", imgKey: "l8_icon", content: {
                    warmup: "å¤§å¤§çš„å¾®ç¬‘ï¼Œç‰™é½’è¼•è¼•å’¬åˆï¼ŒèˆŒé ­å¹³å¹³çš„é ‚åœ¨ç‰™é½’å¾Œé¢ï¼Œç™¼å‡ºåƒè›‡ä¸€æ¨£çš„è²éŸ³ã€Œå˜¶(ã„™)ã€ã€‚",
                    cards: [{t:"ã„—", w:"æ´—æ¾¡", i:ASSETS.l8_card_z}, {t:"ã„˜", w:"åˆºèŸ", i:ASSETS.l8_card_c}, {t:"ã„™", w:"çµ²ç“œ", i:ASSETS.l8_card_s}],
                    game: { title:"æœ¨é ­äººè®Šè®Šè®Š", desc:"è½åˆ°æ²èˆŒéŸ³(å¦‚ã„“)è¦å‹•å‹•èº«é«”ï¼Œè½åˆ°å¹³èˆŒéŸ³(å¦‚ã„—)è¦åƒæœ¨é ­äººä¸èƒ½å‹•(å› ç‚ºèˆŒé ­å¹³å¹³çš„)ã€‚" },
                    quiz: [
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œæ´—æ¾¡ã€çš„è²éŸ³ï¼Ÿ", a:"ã„—", o:["ã„—","ã„˜","ã„™"]},
                        {q:"å“ªä¸€å€‹æ˜¯ã€ŒåˆºèŸã€çš„è²éŸ³ï¼Ÿ", a:"ã„˜", o:["ã„—","ã„˜","ã„™"]},
                        {q:"å“ªä¸€å€‹æ˜¯ã€Œçµ²ç“œã€çš„è²éŸ³ï¼Ÿ", a:"ã„™", o:["ã„—","ã„˜","ã„™"]}
                    ]
                }},
                { id: "L9", title: "L9 è²éŸ³è®Šè®Šè®Š (åˆ†è¾¨ç·´ç¿’)", imgKey: "l9_icon", content: {
                    warmup: "èˆŒé ­é«”æ“ï¼šèˆŒé ­ä¼¸é•·(ã„Œ)ã€èˆŒé ­æ²èµ·(ã„“)ã€èˆŒé ­è®Šå¹³(ã„—)ã€‚ã€‚",
                    cards: [{t:"è¾¨åˆ¥", w:"ã„“vsã„—", i:ASSETS.l9_card_1}, {t:"è¾¨åˆ¥", w:"ã„”vsã„˜", i:ASSETS.l9_card_2}, {t:"è¾¨åˆ¥", w:"ã„•vsã„™", i:ASSETS.l9_card_1}], // ä½¿ç”¨é‡è¤‡çš„åœ–
                    game: { title:"èˆŒé ­è­¦å¯Ÿ", desc:"å­©å­ç•¶è­¦å¯Ÿï¼Œæ‹¿è‘—æ”¾å¤§é¡(æˆ–æ˜¯æ‰‹åœˆèµ·ä¾†)ï¼Œçœ‹çˆ¸çˆ¸åª½åª½å”¸å¾—å°ä¸å°ã€‚å®¶é•·å¯ä»¥æ•…æ„å”¸éŒ¯è®“å­©å­ç³¾æ­£ã€‚" },
                    quiz: [
                        {q:"æ²èµ·ä¾†çš„æ˜¯ï¼Ÿ", a:"ã„“", o:["ã„“","ã„—","ã„™"]},
                        {q:"å¹³å¹³çš„æ˜¯ï¼Ÿ", a:"ã„™", o:["ã„•","ã„™","ã„“"]},
                        {q:"æ²èµ·ä¾†çš„æ˜¯ï¼Ÿ", a:"ã„”", o:["ã„”","ã„˜","ã„™"]}
                    ]
                }}
            ]
        },
        {
            week: 4, title: "ç¬¬å››é€±ï¼šé­”æ³•å’’èªèˆ‡ç•¢æ¥­å…¸ç¦®", color: "#C5E1A5",
            lessons: [
                { id: "L10", title: "L10 å¼µå¤§å˜´å·´é˜¿å–”éµ (ã„šã„›ã„œã„)", imgKey: "l10_icon", content: {
                    warmup: "èª°å˜´å·´å¼µæœ€å¤§ (ã„š)ï¼Œçœ‹èª°å˜´å·´è®Šåœ“å½¢ (ã„›)ã€‚",
                    cards: [{t:"ã„š", w:"é˜¿å§¨", i:ASSETS.l10_card_a}, {t:"ã„›", w:"å…¬é›", i:ASSETS.l10_card_o}, {t:"ã„œ", w:"ç™½éµ", i:ASSETS.l10_card_e}, {t:"ã„", w:"è€¶", i:ASSETS.l10_card_ie}],
                    game: { title:"å˜´å‹çŒœçŒœçœ‹", desc:"å®¶é•·åªåšå˜´å‹ä¸å‡ºè² (ä¾‹å¦‚å¼µå¤§å˜´)ï¼Œè®“å­©å­çŒœæ˜¯å“ªä¸€å€‹å­— (ã„š)ã€‚" },
                    quiz: [
                        {q:"å…¬é›æ€éº¼å«ï¼Ÿ", a:"ã„›", o:["ã„š","ã„›","ã„œ"]},
                        {q:"å˜´å·´å¼µæœ€å¤§ï¼Ÿ", a:"ã„š", o:["ã„š","ã„›","ã„"]},
                        {q:"ç™½éµçš„è²éŸ³ï¼Ÿ", a:"ã„œ", o:["ã„š","ã„œ","ã„"]}
                    ]
                }},
                { id: "L11", title: "L11 ç‰™é½’å°é½Šä¸€çƒé­š (ã„§ã„¨ã„©)", imgKey: "l11_icon", content: {
                    warmup: "å‡è£ç©¿è¡£æœ(ã„§)ã€å‡è£é–‹ç«è»Š(å—šå—šå—š ã„¨)ã€‚",
                    cards: [{t:"ã„§", w:"è¡£æœ", i:ASSETS.l11_card_i}, {t:"ã„¨", w:"çƒé¾œ", i:ASSETS.l11_card_u}, {t:"ã„©", w:"é‡‘é­š", i:ASSETS.l11_card_yu}],
                    game: { title:"ç«è»Šéå±±æ´", desc:"å®¶é•·æ­æ‹±é–€ï¼Œå­©å­ç•¶å°ç«è»Šã€‚å”¸ã€Œã„¨ã€çš„æ™‚å€™ç«è»Šé–‹å‹•ï¼Œå”¸ã€Œã„§ã€çš„æ™‚å€™ç«è»Šæš«åœ(å› ç‚ºè¡£æœæ›åœ¨å¹³äº¤é“ä¸Š...ç™¼æ®æƒ³åƒåŠ›)ã€‚" },
                    quiz: [
                        {q:"å“ªä¸€å€‹å­—å˜´å·´æœ€å˜Ÿèµ·ä¾†ï¼Ÿ", a:"ã„©", o:["ã„§","ã„¨","ã„©"]},
                        {q:"å“ªä¸€å€‹å­—å˜´å·´æœ€å¹³ï¼Ÿ", a:"ã„§", o:["ã„§","ã„¨","ã„©"]},
                        {q:"å“ªä¸€å€‹å­—å˜´å·´æœ€åœ“ï¼Ÿ", a:"ã„¨", o:["ã„§","ã„¨","ã„©"]}
                    ]
                }},
                { id: "L12", title: "L12 å°å°é­”æ³•å¸« (ç°¡å–®æ‹¼è®€å•Ÿè’™)", imgKey: "l12_icon", content: {
                    warmup: "æ­å–œå¤§å®¶ä¾†åˆ°æœ€å¾Œä¸€é—œï¼æˆ‘å€‘ä¾†åšã€Œè²éŸ³é­”æ³•ã€ã€‚",
                    cards: [{t:"æ‹¼", w:"ã„…+ã„š", i:ASSETS.l12_card_1}, {t:"æ‹¼", w:"ã„‡+ã„š", i:ASSETS.l12_card_2}, {t:"ç•¢", w:"æ¥­", i:ASSETS.l12_card_3}],
                    game: { title:"é­”æ³•æ“ŠæŒ", desc:"å­©å­å–Šã„…ï¼Œå®¶é•·å–Šã„šï¼Œç„¶å¾Œä¸€èµ·æ“ŠæŒå–Šã€Œã„…ã„šï¼ã€" },
                    quiz: [
                        {q:"æº–å‚™å¥½ä¸Šå°å­¸äº†å—ï¼Ÿ", a:"æ˜¯", o:["æ˜¯","å¦","å†ç­‰ç­‰"]},
                        {q:"ã„…åŠ ã„šè®Šæˆï¼Ÿ", a:"çˆ¸", o:["çˆ¸","åª½","èŠ±"]},
                        {q:"ã„‡åŠ ã„šè®Šæˆï¼Ÿ", a:"åª½", o:["çˆ¸","åª½","èŠ±"]}
                    ]
                }}
            ]
        }
    ];

    // ==========================================
    // ğŸ® 2. Canvas éŠæˆ²å¼•æ“ (Map System)
    // ==========================================
    const canvas = document.getElementById('gameWorld');
    const ctx = canvas.getContext('2d');
    
    // éŠæˆ²ç‹€æ…‹
    let state = {
        offsetX: 0,
        isDragging: false,
        lastX: 0,
        momentum: 0,
        nodes: [],
        width: 0,
        height: 0,
        maxScroll: 0,
        bgClouds: [],
        starCount: 0
    };

    function initCanvas() {
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // 7. æ”¹ç”¨åœ–ç‰‡é¡¯ç¤ºé›²æœµ
        state.bgClouds = []; // æ¸…ç©ºèˆŠçš„
        for(let i=0; i<15; i++) {
            // éš¨æ©Ÿé¸æ“‡ 1~3 è™Ÿé›²æœµ
            const type = Math.floor(Math.random() * 3) + 1; 
            state.bgClouds.push({
                x: Math.random() * 3000,
                y: Math.random() * 200, // é›²æœµé«˜åº¦ç¯„åœ
                size: 100 + Math.random() * 80, // åœ–ç‰‡å¯¬åº¦ (æ¯”åŸæœ¬åœ“å½¢åŠå¾‘å¤§ä¸€é»)
                speed: 0.2 + Math.random() * 0.5,
                imgKey: `cloud_${type}` // ç´€éŒ„åœ–ç‰‡ Key
            });
        }

        // å»ºç«‹åœ°åœ–ç¯€é»
        const nodeSpacing = 250;
        let currentX = 150;
        
        COURSE_DATA.forEach((week, wIdx) => {
            week.lessons.forEach((lesson, lIdx) => {
                const yOffset = Math.sin(currentX * 0.008) * 150; 
                state.nodes.push({
                    x: currentX,
                    y: (state.height / 2) + yOffset,
                    data: lesson,
                    color: week.color,
                    isWeekStart: lIdx === 0 ? week.title : null,
                    type: 'lesson'
                });
                currentX += nodeSpacing;
            });
            currentX += 100;
        });

        // 10. åŠ å…¥åŸå ¡ (çµ‚é»)
        const lastNode = state.nodes[state.nodes.length-1];
        state.nodes.push({
            x: currentX + 50,
            y: lastNode.y - 50,
            data: { id: "CASTLE", title: "æ³¨éŸ³åŸå ¡" },
            color: "#FFFFFF",
            type: 'castle'
        });
        
        state.maxScroll = currentX + 300 - state.width;
        if(state.maxScroll < 0) state.maxScroll = 0;

        // è®€å–é€²åº¦ä¸¦è·³è½‰
        loadProgress();

        // éš±è— Loader
        setTimeout(() => {
            document.getElementById('loader').style.opacity = 0;
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            setTimeout(() => {
                const hint = document.getElementById('drag-hint');
                if(hint) hint.style.display = 'none';
            }, 3000);
        }, 800);

        requestAnimationFrame(gameLoop);
    }

    function loadProgress() {
        let saved = JSON.parse(localStorage.getItem('zhuyinV7_progress')) || [];
        state.starCount = saved.length;
        document.getElementById('gem-count').innerText = state.starCount;

        // è‡ªå‹•æ²å‹•åˆ°æœ€æ–°é€²åº¦
        if (state.starCount > 0) {
            const targetIdx = Math.min(state.starCount, state.nodes.length - 2); // -2 é¿é–‹åŸå ¡
            if(state.nodes[targetIdx]) {
                let targetX = state.nodes[targetIdx].x - state.width / 2;
                if(targetX < 0) targetX = 0;
                if(targetX > state.maxScroll) targetX = state.maxScroll;
                state.offsetX = targetX;
            }
        }
    }

    function resizeCanvas() {
        state.width = window.innerWidth;
        state.height = window.innerHeight;
        canvas.width = state.width;
        canvas.height = state.height;
        // é‡æ–°è¨ˆç®—ç¯€é» Y (ä¿æŒç½®ä¸­)
        state.nodes.forEach(node => {
            if (node.type === 'lesson') {
                const yOffset = Math.sin(node.x * 0.008) * 150;
                node.y = (state.height / 2) + yOffset;
            } else if (node.type === 'castle') {
                 // åŸå ¡è·Ÿéš¨æœ€å¾Œä¸€å€‹ç¯€é»
                 const lastLesson = state.nodes[state.nodes.length - 2];
                 node.y = lastLesson.y - 50;
            }
        });
    }

    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    function update() {
        if (!state.isDragging && Math.abs(state.momentum) > 0.1) {
            state.offsetX -= state.momentum;
            state.momentum *= 0.95;
            if (state.offsetX < 0) { state.offsetX = 0; state.momentum = 0; }
            if (state.offsetX > state.maxScroll) { state.offsetX = state.maxScroll; state.momentum = 0; }
        }
        state.bgClouds.forEach(cloud => {
            cloud.x -= cloud.speed;
            if(cloud.x + cloud.size < 0) cloud.x = 3000;
        });
    }

    function draw() {
        // å¤©ç©º
        const grad = ctx.createLinearGradient(0, 0, 0, state.height);
        grad.addColorStop(0, "#81D4FA");
        grad.addColorStop(1, "#E0F7FA");
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, state.width, state.height);

        ctx.save();
        
        // 7. é›²æœµ (å®‰å…¨ä¿®æ­£ç‰ˆ)
        state.bgClouds.forEach(cloud => {
            const renderX = cloud.x - (state.offsetX * 0.5 * 0.3); 
            
            if(renderX > -300 && renderX < state.width + 300) {
                const img = imgObj[cloud.imgKey];
                // ä¿®æ­£ï¼šå¿…é ˆæª¢æŸ¥ naturalWidth > 0ï¼Œé¿å…é™¤ä»¥ 0 é€ æˆ crash
                if (img && img.complete && img.naturalWidth > 0) {
                    const ratio = img.naturalHeight / img.naturalWidth; 
                    const h = cloud.size * ratio;
                    ctx.drawImage(img, renderX, cloud.y, cloud.size, h);
                }
            }
        });

        ctx.translate(-state.offsetX, 0);

        // é“è·¯
        ctx.strokeStyle = "#FFFFFF";
        ctx.lineWidth = 40;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.shadowBlur = 10;
        ctx.shadowColor = "rgba(0,0,0,0.1)";

        if (state.nodes.length > 1) {
            ctx.beginPath();
            ctx.moveTo(state.nodes[0].x, state.nodes[0].y);
            // åªç•«åˆ°å€’æ•¸ç¬¬äºŒå€‹ (èª²ç¨‹ç¯€é»)ï¼ŒåŸå ¡å¦å¤–ç•«
            for (let i = 0; i < state.nodes.length - 2; i++) {
                const p1 = state.nodes[i];
                const p2 = state.nodes[i+1];
                const xc = (p1.x + p2.x) / 2;
                const yc = (p1.y + p2.y) / 2;
                ctx.quadraticCurveTo(p1.x, p1.y, xc, yc);
            }
            let lastLesson = state.nodes[state.nodes.length-2];
            ctx.lineTo(lastLesson.x, lastLesson.y);
            ctx.stroke();
        }
        
        ctx.shadowBlur = 0;

        // ç¯€é»
        const savedProgress = JSON.parse(localStorage.getItem('zhuyinV7_progress')) || [];
        
        state.nodes.forEach((node, index) => {
            if (node.x < state.offsetX - 150 || node.x > state.offsetX + state.width + 150) return;

            if (node.type === 'lesson') {
                // é€±æ¬¡æ¨™é¡Œ
                if (node.isWeekStart) {
                    ctx.fillStyle = node.color;
                    ctx.beginPath();
                    ctx.roundRect(node.x - 70, node.y - 130, 140, 34, 17);
                    ctx.fill();
                    ctx.fillStyle = "#fff";
                    ctx.font = "bold 16px 'Zen Maru Gothic'";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(node.isWeekStart.split('ï¼š')[0], node.x, node.y - 113);
                }

                // åˆ¤æ–·é–å®š
                const isDone = savedProgress.includes(node.data.id);
                // åªè¦ä¸æ˜¯ç¬¬ä¸€èª²ï¼Œä¸”å‰ä¸€èª²æ²’å®Œæˆï¼Œå°±æ˜¯é–å®š
                const isLocked = index > 0 && !savedProgress.includes(state.nodes[index-1].data.id);

                // å¤–åœ“
                ctx.beginPath();
                ctx.arc(node.x, node.y, 55, 0, Math.PI * 2);
                ctx.fillStyle = isLocked ? "#CFD8DC" : node.color;
                ctx.shadowColor = "rgba(0,0,0,0.15)";
                ctx.shadowBlur = 10;
                ctx.shadowOffsetY = 5;
                ctx.fill();
                ctx.shadowBlur = 0;
                ctx.shadowOffsetY = 0;

                // å…§åœ“
                ctx.beginPath();
                ctx.arc(node.x, node.y, 48, 0, Math.PI * 2);
                ctx.fillStyle = "#ffffff";
                ctx.fill();

                // 6. ç¹ªè£½ä¸»é¡Œåœ–ç‰‡ (å¦‚æœè¼‰å…¥å®Œæˆ)
                if(!isLocked && node.data.imgKey && imgObj[node.data.imgKey] && imgObj[node.data.imgKey].complete) {
                     ctx.save();
                     ctx.beginPath();
                     ctx.arc(node.x, node.y, 40, 0, Math.PI*2);
                     ctx.clip();
                     ctx.drawImage(imgObj[node.data.imgKey], node.x - 40, node.y - 40, 80, 80);
                     ctx.restore();
                } else if (isLocked) {
                    ctx.font = "900 30px 'Font Awesome 6 Free'";
                    ctx.fillStyle = "#B0BEC5";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText("\uf023", node.x, node.y); // Lock icon
                } else {
                    // Fallback æ–‡å­—
                    ctx.fillStyle = node.color;
                    ctx.font = "bold 24px 'Zen Maru Gothic'";
                    ctx.fillText(node.data.id, node.x, node.y + 5);
                }

                // å®Œæˆæ˜Ÿæ˜Ÿ
                if (isDone) {
                    ctx.font = "900 24px 'Font Awesome 6 Free'";
                    ctx.fillStyle = "#FFD700";
                    ctx.strokeStyle = "#fff";
                    ctx.lineWidth = 3;
                    ctx.strokeText("\uf005", node.x + 35, node.y - 35);
                    ctx.fillText("\uf005", node.x + 35, node.y - 35);
                }

                // èª²ç¨‹åç¨±
                ctx.fillStyle = "#5D4037";
                ctx.font = "bold 16px 'Zen Maru Gothic'";
                ctx.fillText(node.data.title.split(' ')[1], node.x, node.y + 80);

            } else if (node.type === 'castle') {
                // åŸå ¡
                const isUnlocked = state.starCount >= 12;
                const size = 200;
                if(imgObj.home_castle.complete) {
                    if(!isUnlocked) ctx.filter = "grayscale(100%) opacity(0.7)";
                    ctx.drawImage(imgObj.home_castle, node.x - size/2, node.y - size/2, size, size);
                    ctx.filter = "none";
                }
                
                if(!isUnlocked) {
                    ctx.font = "900 40px 'Font Awesome 6 Free'";
                    ctx.fillStyle = "#555";
                    ctx.fillText("\uf023", node.x, node.y);
                }
            }
        });

        ctx.restore();
    }
    
    // ç•«é›²è¼”åŠ©å‡½å¼
    function drawCloud(ctx, x, y, size) {
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.arc(x - size*0.5, y + size*0.2, size*0.7, 0, Math.PI * 2);
        ctx.arc(x + size*0.5, y + size*0.2, size*0.7, 0, Math.PI * 2);
        ctx.fill();
    }

    // ==========================================
    // ğŸ–±ï¸ 3. è¼¸å…¥äº‹ä»¶è™•ç†
    // ==========================================
    let dragStartX = 0;
    let dragStartTime = 0;

    canvas.addEventListener('mousedown', startDrag);
    canvas.addEventListener('touchstart', (e) => startDrag(e.touches[0]));
    window.addEventListener('mousemove', drag);
    window.addEventListener('touchmove', (e) => drag(e.touches[0]));
    window.addEventListener('mouseup', endDrag);
    window.addEventListener('touchend', endDrag);

    function startDrag(e) {
        state.isDragging = true;
        state.lastX = e.clientX;
        dragStartX = e.clientX;
        dragStartTime = Date.now();
        state.momentum = 0;
    }

    function drag(e) {
        if (!state.isDragging) return;
        const delta = e.clientX - state.lastX;
        state.offsetX -= delta;
        if (state.offsetX < -50) state.offsetX = -50; 
        if (state.offsetX > state.maxScroll + 50) state.offsetX = state.maxScroll + 50;
        state.lastX = e.clientX;
        state.momentum = delta * -0.8;
    }

    function endDrag(e) {
        state.isDragging = false;
        const dist = Math.abs(state.lastX - dragStartX);
        const time = Date.now() - dragStartTime;
        if (dist < 10 && time < 300) {
            handleTap(dragStartX, e.clientY || state.nodes[0].y); // ä½¿ç”¨æœ€å¾Œä¸€æ¬¡ Y æˆ–é è¨­
        }
    }

    function handleTap(screenX, screenY) {
        const worldX = screenX + state.offsetX;
        const worldY = screenY; // Y ä¸å— offset å½±éŸ¿

        // 9. ä¿®å¾©é»æ“Šå¤©ç©ºä¹Ÿæœƒé€²å…¥èª²ç¨‹çš„ Bug
        state.nodes.forEach((node, idx) => {
            // åš´æ ¼åˆ¤å®šï¼šè¨ˆç®—é»æ“Šé»èˆ‡åœ“å¿ƒçš„è·é›¢
            const dx = worldX - node.x;
            const dy = worldY - node.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            // åˆ¤å®šåŠå¾‘è¨­ç‚º 60px (æ¯”è¦–è¦ºåœ“ç¨å¤§ä¸€é»é»ä»¥ä¾¿é»æ“Š)
            if (dist < 60) {
                if (node.type === 'lesson') {
                    const saved = JSON.parse(localStorage.getItem('zhuyinV7_progress')) || [];
                    const isLocked = idx > 0 && !saved.includes(state.nodes[idx-1].data.id);
                    if(!isLocked) {
                        openLesson(node.data);
                    } else {
                        speak("é€™ä¸€é—œé‚„æ²’è§£é–å–”");
                    }
                } else if (node.type === 'castle') {
                    // 10. åŸå ¡è§£é–
                    if (state.starCount >= 12) {
                        fireConfetti();
                        speak("æ­å–œä½ ï¼å®Œå…¨ç ´é—œäº†ï¼");
                        alert("ğŸ‰ æ­å–œä½ æ”¶é›†æ»¿12é¡†æ˜Ÿæ˜Ÿï¼Œè§£é–äº†æ³¨éŸ³åŸå ¡ï¼");
                    } else {
                        speak("è¦æ”¶é›†12é¡†æ˜Ÿæ˜Ÿæ‰èƒ½æ‰“é–‹åŸå ¡");
                    }
                }
            }
        });
    }

    // ==========================================
    // ğŸ“š 4. èª²ç¨‹é‚è¼¯
    // ==========================================
    let currentLesson = null;
    let currentTab = 0;
    let quizIdx = 0;

    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW';
            window.speechSynthesis.speak(u);
        }
    }

    function openLesson(lessonData) {
        currentLesson = lessonData;
        currentTab = 0;
        quizIdx = 0;
        
        document.getElementById('lesson-title-display').innerText = lessonData.title;
        document.getElementById('lesson-modal').style.display = 'flex';
        // 5. ä¿®å¾©Bug: ç¢ºä¿é€²å…¥æ™‚é ç±¤é‡ç½®ç‚º 0 (æš–èº«)
        switchTab(0); 
    }

    function closeLesson() {
        document.getElementById('lesson-modal').style.display = 'none';
        window.speechSynthesis.cancel();
        // é›¢é–‹æ™‚å­˜æª”ä¸¦æ›´æ–°ç•«é¢ (é‡æ–°ç¹ªè£½ Map ä»¥é¡¯ç¤ºæ–°æ˜Ÿæ˜Ÿ)
        loadProgress(); 
    }

    function switchTab(idx) {
        currentTab = idx;
        // æ›´æ–° UI ç‹€æ…‹
        document.querySelectorAll('.tab-item').forEach((el, i) => {
            el.classList.toggle('active', i === idx);
            // ç¢ºä¿åœ–ç¤ºé¡è‰²ä¹Ÿè·Ÿè‘—è®Š
            const icon = el.querySelector('i');
            if(i === idx) {
                el.style.color = 'white';
            } else {
                el.style.color = '#999';
            }
        });
        renderTabContent(idx);
    }

    function renderTabContent(idx) {
        const container = document.getElementById('lesson-container');
        container.innerHTML = "";
        const data = currentLesson.content;

        if (idx === 0) { // æš–èº«
            // 4. clay-cardç¶­æŒæ»¿ç‰ˆï¼Œæ–‡å­—ç½®ä¸­
            container.innerHTML = `
                <div class="clay-card animate__animated animate__fadeIn">
                    <img src="${ASSETS[currentLesson.imgKey] || ASSETS.default}" style="width:120px; height:120px; object-fit:contain; margin-bottom:15px;">
                    <h3 class="fw-bold mb-3">æš–èº«å‹•ä½œ</h3>
                    <p class="fs-4 fw-bold text-main">${data.warmup}</p>
                </div>
            `;
        } else if (idx === 1) { // å­—å¡
            let html = `<div class="flashcard-grid">`;
            data.cards.forEach(c => {
                // å¦‚æœå­—å¡æœ¬èº«æ²’å®šç¾©åœ–ï¼Œç”¨é è¨­åœ–
                const imgUrl = c.i || ASSETS.default;
                html += `
                    <div class="flashcard" onclick="speak('${c.t}ï¼Œ${c.w}')">
                        <!-- å·¦é‚Šï¼šæ³¨éŸ³ -->
                        <div style="font-size:5rem; color:var(--primary); font-weight:900; width:45%; text-align:center;">${c.t}</div>
                        <!-- å³é‚Šï¼šåœ–ç‰‡èˆ‡èªªæ˜ -->
                        <div class="d-flex flex-column align-items-center justify-content-center" style="width:55%;">
                            <img src="${imgUrl}">
                            <div class="fw-bold text-muted" style="font-size:1.5rem;">${c.w}</div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            container.innerHTML = html;
        } else if (idx === 2) { // éŠæˆ²
            container.innerHTML = `
                <div class="clay-card">
                    <img src="${ASSETS[currentLesson.imgKey] || ASSETS.default}" style="width:120px; height:120px; object-fit:contain; margin-bottom:15px;">
                    <h3 class="fw-bold mb-3">${data.game.title}</h3>
                    <p class="fs-4 fw-bold text-main">${data.game.desc}</p>
                </div>
            `;
        } else if (idx === 3) { // æ¸¬é©—
            // 3. æ¢å¾© 3 å€‹æ¸¬é©—ï¼Œé¡¯ç¤ºé‚è¼¯
            if (quizIdx >= data.quiz.length) {
                // å®Œæˆ
                saveProgress(currentLesson.id);
                container.innerHTML = `
                    <div class="text-center py-5">
                        <img src="${ASSETS.finish_star}" style="width:100px; margin-bottom:20px;" class="animate-bounce">
                        <h2 class="fw-bold mb-3">å¤ªæ£’äº†ï¼</h2>
                        <p class="text-muted fs-5">ç²å¾—ä¸€é¡†æ˜Ÿæ˜Ÿ</p>
                        <button class="btn btn-primary rounded-pill px-5 mt-4 py-2 fs-5 shadow" style="background-color: var(--btn-primary); border-color: var(--btn-primary);" onclick="closeLesson()">å›åˆ°åœ°åœ–</button>
                    </div>
                `;
                fireConfetti();
            } else {
                const q = data.quiz[quizIdx];
                speak(q.q);
                // 3. é¸é …æ”¹ç‚ºæ©«å‘ Grid (quiz-options-grid)
                let opts = q.o.map(opt => `<div class="quiz-option" onclick="checkAns(this, '${opt}', '${q.a}')">${opt}</div>`).join('');
                container.innerHTML = `
                    <div class="text-center">
                        <div class="text-muted mb-2">ç¬¬ ${quizIdx+1} / ${data.quiz.length} é¡Œ</div>
                        <h3 class="fw-bold mb-4">${q.q}</h3>
                        <div class="quiz-options-grid">
                            ${opts}
                        </div>
                    </div>
                `;
            }
        }
    }

    function checkAns(el, ans, correct) {
        if (ans === correct) {
            el.classList.add('correct');
            speak("ç­”å°äº†");
            setTimeout(() => {
                quizIdx++;
                renderTabContent(3);
            }, 800);
        } else {
            el.classList.add('wrong');
            speak("å†è©¦ä¸€æ¬¡");
            setTimeout(() => el.classList.remove('wrong'), 500);
        }
    }

    // 12. é€²åº¦å„²å­˜ (ä½¿ç”¨ localStorage)
    function saveProgress(id) {
        let saved = JSON.parse(localStorage.getItem('zhuyinV7_progress')) || [];
        if (!saved.includes(id)) {
            saved.push(id);
            localStorage.setItem('zhuyinV7_progress', JSON.stringify(saved));
        }
    }

    function resetApp() {
        if (confirm("è¦é‡ç½®æ‰€æœ‰é€²åº¦å—ï¼Ÿ(æ˜Ÿæ˜Ÿå°‡æ­¸é›¶)")) {
            localStorage.removeItem('zhuyinV7_progress');
            loadProgress();
            // é‡ç½®ä½ç½®
            state.offsetX = 0;
        }
    }

    // å•Ÿå‹•
    initCanvas();

    function fireConfetti() {
        const colors = ['#FF9EAA', '#80DEEA', '#FFE082'];
        for(let i=0; i<50; i++) {
            const el = document.createElement('div');
            el.style.position = 'fixed';
            el.style.left = Math.random()*100 + 'vw';
            el.style.top = '-10px';
            el.style.width = '12px';
            el.style.height = '12px';
            el.style.background = colors[Math.floor(Math.random()*3)];
            el.style.transition = 'top 1s ease-in, transform 1s linear';
            el.style.zIndex = '9999';
            document.body.appendChild(el);
            setTimeout(() => {
                el.style.top = '100vh';
                el.style.transform = `rotate(${Math.random()*720}deg)`;
            }, 10);
            setTimeout(() => el.remove(), 1000);
        }
    }
</script>
</body>
</html>